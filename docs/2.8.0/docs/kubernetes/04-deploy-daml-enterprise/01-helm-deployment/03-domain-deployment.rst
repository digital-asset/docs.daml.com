.. Copyright (c) 2023 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
.. SPDX-License-Identifier: Apache-2.0

Install ``canton-domain`` chart
###############################

Objectives
**********

* Customize the Helm chart parameters
* Install the Helm chart
* Verify the deployment status

Steps
*****

1. Inspect the Helm value files generated by Terraform
======================================================

.. note::
   The Terraform scripts parameterize the Helm values. For a standalone Helm deployment without Terraform, you must customize the value file manually. The value file is located under `domain.yaml <https://github.com/DACH-NY/daml-enterprise-deployment-blueprints/blob/main/azure/helm/values/domain.yaml>`_.

.. code-block:: yaml

   ---
   image:
     registry: "<container_image_registry_hostname>"

   storage:
     host: "<postgresql_server_hostname>"

   bootstrap:
     enabled: true

   console:
     enabled: true

   certManager:
     issuerGroup: certmanager.step.sm
     issuerKind: StepClusterIssuer

   common:
     tls:
       public:
         enabled: true
         certManager:
           issuerName: canton-tls-issuer
       admin:
         enabled: true
         certManager:
           issuerName: canton-tls-issuer

   manager:
     storage:
       database: "mydomain"
       user: "mydomain"
       existingSecret:
         name: "mydomain-postgresql"
         key: "mydomain"

   mediator:
     storage:
       database: "mymediator"
       user: "mymediator"
       existingSecret:
         name: "mymediator-postgresql"
         key: "mymediator"

   sequencer:
     storage:
       database: "mysequencer"
       user: "mysequencer"
       existingSecret:
         name: "mysequencer-postgresql"
         key: "mysequencer"

   testing:
     bootstrap:
       remoteParticipants:
         - name: "participant1"
           host: "participant1-canton-participant.canton.svc.cluster.local"
           tls:
             admin:
               enabled: true
               certManager:
                 issuerName: canton-tls-issuer
               ca: "/tls-participant1/ca.crt"

.. note::
   To learn about the supported attributes for ``canton-domain``, see the `canton-domain documentation <https://artifacthub.io/packages/helm/digital-asset/canton-domain#parameters>`_.

2. Install the chart
====================

After preparing the value files, install the Helm chart:

.. code-block:: bash

   helm -n canton install mydomain digital-asset/canton-domain -f azure/helm/values/domain.yaml

When the other resources are deployed and ready, the bootstrap job starts. It takes a few minutes. Once this job is completed, the Helm chart deployment is successful.

Expected output:

.. code-block:: bash

   NAME: mydomain
   LAST DEPLOYED: Wed Aug 16 16:27:15 2023
   NAMESPACE: canton
   STATUS: deployed
   REVISION: 1
   TEST SUITE: None
   NOTES:
   *
     _____            _
    / ____|          | |
   | |     __ _ _ __ | |_ ___  _ __
   | |    / _` | '_ \| __/ _ \| '_ \
   | |___| (_| | | | | || (_) | | | |
    \_____\__,_|_| |_|\__\___/|_| |_|

   Domain 2.7.1 has been deployed successfully!

   More information on how to configure Canton can be found in our documentation:

   https://docs.daml.com/

3. Check deployment status
==========================

You can check the status of the deployment using the following command:

.. code-block:: bash

   kubectl -n canton get pods

Expected output:

.. code-block:: bash

   NAME                                                READY   STATUS      RESTARTS   AGE
   mydomain-canton-domain-bootstrap-dcbsr              0/1     Completed   0          15m
   mydomain-canton-domain-console-6b86bf5d4f-djfj8     1/1     Running     0          15m
   mydomain-canton-domain-manager-59f8b9688d-kdgbk     1/1     Running     0          15m
   mydomain-canton-domain-mediator-75f7665845-kxt49    1/1     Running     0          15m
   mydomain-canton-domain-sequencer-5768f45457-bl4pb   1/1     Running     0          15m
   mydomain-canton-domain-sequencer-5768f45457-zkxf9   1/1     Running     0          15m
   participant1-canton-participant-647b99cb8b-dbzrw    1/1     Running     0          15m
