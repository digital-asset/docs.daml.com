<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<title>Participant Query Store User Guide</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="participant-query-store-user-guide">
<h1 class="title">Participant Query Store User Guide</h1>

<!-- Copyright (c) 2023 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<div class="section" id="docker-image">
<h1>Docker image</h1>
<p>To get the Participant Query Store (PQS) Docker image, run the following command:</p>
<pre class="literal-block">
docker pull digitalasset-docker.jfrog.io/participant-query-store:0.1.0
</pre>
</div>
<div class="section" id="introduction">
<h1>Introduction</h1>
<p>The term operational datastore (ODS) usually refers to a database that mirrors
the ledger and allows for efficient querying. The Participant Query Store
(PQS) feature acts as an ODS for the participant node. PQS provides a
unidirectional path for exporting data from the ledger event stream to a
PostgreSQL datastore. Data is exported in an append-only fashion and provides
a stable view of data for purposes such as point-in-time queries. It stores
contract creation, contract archival, and exercise information in a PostgreSQL
database using a JSONB column format. You access the data using SQL over a
JDBC connection.</p>
<p>The PQS is intended for high throughput and complex queries, for which the Canton ledger (gRPC Ledger API) and the JSON API are not optimized. The PQS is useful for:</p>
<ul class="simple">
<li>Application developers to access data on the ledger, observe the evolution of data, and debug their applications.</li>
<li>Business analysts to analyze ledger data and create reports.</li>
<li>Support teams to debug any problems that happen in production.</li>
<li>Application operators to take a full snapshot of the ledger (from the start of the ledger to the current latest transaction). Alternatively, they can take a partial snapshot of the ledger (between specific <a class="reference external" href="https://docs.daml.com/app-dev/grpc/proto-docs.html#ledgeroffset">offsets</a>).</li>
<li>Report writers to extract historical data and then stream indefinitely (either from the start of the ledger or from a specific offset).</li>
</ul>
<p>There are many other uses.</p>
</div>
<div class="section" id="overview">
<h1>Overview</h1>
<div class="section" id="architecture">
<h2>Architecture</h2>
<p>The typical configuration is to have a separate PQS instance with its own DB for each participant node (shown in the figure). In this configuration, the PQS extracts contract information for all parties on the participant node. As data is physically segregated by Daml participants and hosted Daml parties must trust the node operator, they may trust the operator to protect the PQS privacy as well. A more restricted configuration is possible that limits the parties for which the PQS extracts information.</p>
<p>A client application can access the PQS directly using a JDBC connection where the data access rights are defined by the PostgreSQL database (left side in the figure). In this case, having access to the database means that the user has access to all the content in the database. If finer-grained access is needed, a read-only query service (right side in the figure) can be inserted between the client application and the PQS. That query service can filter out what a client application can see. This is a fairly <a class="reference external" href="https://www.bezkoder.com/spring-boot-jdbctemplate-crud-example/">standard pattern</a> in the industry.</p>
<object data="./images/access-connection.svg" type="image/svg+xml">A diagram showing different ways to connect to the Participant Query Store</object>
<p>To understand the format that PQS outputs into a Postgres document-oriented cache, you must understand how the ledger stores data. The Daml ledger is composed of transactions, which generate events. An event can represent one of these situations:</p>
<ul class="simple">
<li>Creation of contracts (&quot;create event&quot;)</li>
<li>Exercise of a choice on a contract (&quot;exercise event&quot;), which archives the contract if it is a consuming choice</li>
</ul>
<p>A contract on the ledger is either created or archived. The relationships between transactions and contracts are captured in the database as follows:</p>
<ul class="simple">
<li>All contracts have links (foreign keys) to the transaction in which they were created.</li>
<li>Archived contracts have pointers to the transaction in which they were archived.</li>
</ul>
<p>Transactions on the ledger are inserted into PostgreSQL concurrently for high performance. Consistency for readers is provided through a watermark mechanism that indicates a consistent offset from which readers can consume for a fully consistent ledger. These details are managed for readers through the functions available in PostgreSQL. Depending on your needs, readers may wish to use or bypass these mechanisms, depending on the type of query and consistency required.</p>
</div>
<div class="section" id="pqs-schema-design">
<h2>PQS schema design</h2>
<p>PQS is not directly involved in querying/reading the datastore - the
application is free to query it, such as via JDBC. The objectives of the
schema design is to facilitate:</p>
<ul class="simple">
<li><strong>Scalable writes</strong>: transactions are written in parallel, so
writes do not need to be sequential.</li>
<li><strong>Scalable reads</strong>: queries can be parallelized and are not
blocked by writes. They produce sensible query plans with no
unnecessary table scans.</li>
<li><strong>Ease of use</strong>: readers can use familiar tools and techniques to
query the datastore without needing to understand the specifics of
the schema design. Simple entry points
provide access to data in familiar ways. In particular, readers
do not need to navigate the offset-based model.</li>
<li><strong>Read consistency</strong>: readers can achieve the level of
consistency that they require, including consistency with other
ledger datastores, or with ledger commands that have been executed.</li>
</ul>
<p>The following principles apply:</p>
<ul class="simple">
<li><strong>Append-only</strong>: only INSERTs are used, and no UPDATEs or DELETEs are
used in transaction processing.</li>
<li><strong>Offset-based</strong>: all physical tables are indexed by offset, meaning that
all ledger data is known in terms of the offset in which it was
committed to the ledger.</li>
<li><strong>Implicit offset</strong>: readers can opt for queries with implicit offset,
meaning they can ignore the role of offset in their queries but
still provide a stable view of the ledger data. Much like PostgreSQL
provides MVCC capabilities without the reader needing to understand
the underlying implementation, this provides a similar
experience for readers of the ledger data.</li>
<li><strong>Idempotent</strong>: PQS is designed to be restarted at any time, and it will
not impact the integrity of the data. This is achieved by using the
offset-based model and ensuring that (other than the datastore
itself) PQS is stateless.</li>
<li><strong>Watermarks</strong>: PQS maintains a watermark of the latest contiguous
offset, representing the point of the ledger that has been fully
processed. This is used to ensure that the ledger data has read
consistency, without requiring readers to perform table
scans. This resolves the uncertainty created by the
parallel writes.</li>
</ul>
</div>
<div class="section" id="json-data">
<h2>JSON data</h2>
<p>Relational databases excel at storing structured data for which the schema is
known in advance. However, they have traditionally lacked mechanisms for data
that is more dynamic or evolves. For example, you may want to store arbitrary
Daml contracts and might prefer not to update the database schema every time
the underlying template changes.</p>
<p>PostgreSQL helps manage unstructured data through native support for JSON data
and allows queries to process this data. For best performance, the PQS stores
data as JSONB only.</p>
<p>An example query might look like this:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace">
</span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">contract</span><span class="whitespace">
</span><span class="keyword">WHERE</span><span class="whitespace"> </span><span class="name">payload</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'isin'</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal string single">'abc123'</span><span class="whitespace">
</span><span class="keyword">ORDER</span><span class="whitespace"> </span><span class="keyword">BY</span><span class="whitespace"> </span><span class="name">payload</span><span class="operator">-&gt;</span><span class="literal string single">'issuanceData'</span><span class="operator">-&gt;</span><span class="literal string single">'issueDate'</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'Some'</span><span class="punctuation">;</span>
</pre>
<p>For more information on querying JSON data, see the section <a class="reference external" href="https://www.postgresql.org/docs/12/functions-json.html">JSON Functions
and Operators</a> in
the PostgreSQL manual. The operators <tt class="docutils literal"><span class="pre">-&gt;</span></tt>, <tt class="docutils literal"><span class="pre">-&gt;&gt;</span></tt>, <tt class="docutils literal">#&gt;</tt>, <tt class="docutils literal">#&gt;&gt;</tt>, and
<tt class="docutils literal">&#64;&gt;</tt> may be of particular interest.</p>
<p>The <a class="reference external" href="#pqs-json-encoding">JSON format section below</a> summarizes how the ledger data is encoded in JSON.</p>
</div>
<div class="section" id="continuity">
<h2>Continuity</h2>
<p>The PQS is intended for continuous operation. Upon restart after an interruption, PQS determines the last consistent offset and continues incremental processing from that point onward. PQS terminates when encountering any error and leaves it up to the orchestration layer (such as Kubernetes) or the operator to determine the appropriate course of action.</p>
</div>
<div class="section" id="high-availability">
<h2>High availability</h2>
<p>Multiple isolated instances of PQS can be instantiated without any cross-dependency. This allows for an active-active high availability clustering model. Please note that different instances might not be at the same offset due to different processing rates or other factors. After querying one active instance, you can see results that are not yet visible on an alternative active instance. This requires consideration for the client to handle the situation where waiting or a retry is required to service &quot;at least up to&quot; requests.</p>
</div>
</div>
<div class="section" id="how-a-participant-node-pn-models-time">
<h1>How a participant node (PN) models time</h1>
<p>Understanding time in a distributed application is challenging because there is no global clock. This section describes how a participant node understands time. If you are familiar with Canton, skip this section and move to the section <a class="reference external" href="#pqs-time-model">Time Model within PQS</a>.</p>
<p>A participant node models time advancing in its local ledger using an index called an <em>offset</em>. An offset is a unique index of the participant node's local ledger. You can think of this as selecting an item in the ledger using a specific offset (or index) into the ledger. For example, in the figure, Participant A has transaction “ABC” at offset #011. An offset represents a point in time of that participant node and a given domain, where the offset values order the events that are changes to the ledger. Specifically, subscribers to UpdateService observe the order for a specific domain.</p>
<p>In general, a larger participant offset means that the event happened after the event at a smaller participant offset in that participant node. Since ledger entries can be made at any time, they can advance at different rates. For example, Participant A may only process requests every several minutes, so its offset counters increase slowly. However, Participant B may be processing requests very frequently, so its offset counters may increase several times a second.</p>
<p>The sequence of offsets of a participant may contain gaps. That is because some offsets may be used for purposes internal to the participant that never show up on the ledger API. Also, filtering for certain types of changes (such as by party or by template ID) naturally results in gaps in the sequence of offsets.</p>
<object data="./images/offset-sequence.svg" type="image/svg+xml">Charts of offsets and transactions for two participants connected by a sync domain</object>
<p>You cannot compare offset values across participants. The same ledger change (such as a transaction) for multiple participant nodes is stored at a different offset in each participant node. For example, in the figure, the transaction ABC is at offset #011 in Participant A but at offset #010 in Participant B. Similarly, the same offset value across participant nodes refers to different ledger changes. In the figure, Participant A's offset #011 records “Tx ABC” while Participant B's offset #011 records “Tx DEF”. Comparing offsets across synchronization domains does not provide a causal ordering of the events because there is no common reference.</p>
<p>Single offset values returned by the Ledger API can be used as-is (for example, to keep track of processed transactions and provide an application restart point in case you need to retry the request).</p>
<p>The Ledger API endpoints that take offset values also allow an offset range which is a portion of the participant's ledger that is relevant for the client to read. An offset range is analogous to a duration or slice of time. For example, a client application can specify the offset range from #010 through #012 to perform a search within Participant B's ledger.</p>
<p>Although the figure shows integers as an offset value, this may change. The format of offsets should be treated as opaque to the client. No client-side transformation of an offset (such as subtracting or adding one offset to another and using that in a ledger read)  is guaranteed to return a meaningful offset. However, you can always expect that offsets are lexicographically comparable.</p>
<p>A transaction ID compares to an offset in the following ways:</p>
<blockquote>
<ul class="simple">
<li>Not every offset has a transaction ID. For example, the completion event of a rejected transaction does not have a transaction ID because the transaction did not successfully complete.</li>
<li>There is, at most, one transaction ID at a single offset.</li>
<li>Every accepted transaction is published at a single offset.</li>
<li>Offsets are local to a participant, whereas transaction IDs are virtual ledger-wide identifiers to correlate transactions across multiple participants.</li>
<li>Offsets can establish a temporal ordering within the same sync domain (&quot;happened-before&quot; relationship) between transactions and/or events from different transactions.</li>
</ul>
</blockquote>
<p>For analysis of a participant node's ledger, the offset is a better identifier than transaction ID because it can be used for ordering and an offset range can be specified to limit the analysis. However, if the analysis must coordinate with other participant nodes, then transaction IDs are better.</p>
<p>If a participant node's ledger is restored from a backup, it reviews the data on the sequencer and processes it to the latest information. However, in performing this rehydration, the resulting PN can have a different set of offset values than it had before the backup. For Daml 2.x, the order of event processing and transaction IDs remain the same, but the resulting offsets likely change. If a client application caches offset data or stores it in a database, those datastores also need to be replayed to have the proper offset values of the restored participant node.</p>
<div class="section" id="time-model-within-pqs">
<span id="pqs-time-model"></span><h2>Time model within PQS</h2>
<p>PQS builds on the offset concept of the participant node's ledger, and PQS is a valid representation of that ledger. PQS processes events asynchronously and concurrently, but the PQS programming model is intended to simplify development. The offset forms the basis for the PQS programming model. Helper functions make it easy to reason about offset values, pushing that complexity into the background. This section discusses how PQS models time.</p>
<p>NOTE:  Use of the helper functions is required for your application to upgrade in future releases. Direct table access is unsupported because the schema may change in a future release. There should be no inherent overhead in using the API so performance should not suffer.</p>
<p>The following figure shows the simplest view of a participant node and its query store. Consider the ledger client and PQS client as separate entities. The PQS consists of two components: Scribe and the PostgreSQL database.</p>
<object data="./images/node-view.svg" type="image/svg+xml">A diagram showing a ledger client and a PQS client with Scribe and Postgres as components</object>
<p>The asynchronous and concurrent processing of an event can result in out-of-order results written to the database, but their offset values will correspond to the participant offset values. The following scenario illustrates this:</p>
<ol class="arabic simple">
<li>A participant emits a ledger event at offset #1, which is processed by Scribe and then immediately stored to the postgres database in a transaction.</li>
<li>A ledger event at offset #2 is passed to Scribe but does not finish processing immediately.</li>
<li>Scribe receives a ledger event at offset #3, processes it immediately, and stores it in the database.</li>
<li>Ledger event #2 finishes processing and is stored in the database. In this situation, the result for offset #3 is stored in the database before offset #2. The result for offset #3 could be queried without offset #2, which could result in an erroneous query result.</li>
</ol>
<p>The asynchronous, concurrent processing of ledger events leads to four concepts related to offsets:</p>
<ul class="simple">
<li><strong>Processed</strong>: ledger events that have been processed and the payload is stored in the database.</li>
<li><strong>Watermark</strong>: offset for the most recent consistent and stable event processed. As more events are processed, the watermark offset moves. The watermark can jump several offsets at once.</li>
<li><strong>Gap events</strong>: events that are in flight, being processed, and have not yet completed processing.</li>
<li><strong>Flushed events</strong>: events that have been processed, but their offset is later than the offset of (one or more) gap events.</li>
</ul>
<p>The following section provides an example of these concepts.</p>
<div class="section" id="example-daml-model">
<h3>Example Daml model</h3>
<p>The example Daml model highlights the following:</p>
<ul class="simple">
<li>The time at which a ledger event begins and ends processing</li>
<li>The offset where the event (such as contract creation) occurs</li>
<li>The offset at which a contract is archived</li>
</ul>
<p>The example is a mix of the wall clock time and offset information.</p>
<p>The example covers creation, modification, and retirement of birth certificates. The operations are:</p>
<ul class="simple">
<li>Create a birth certificate with a name.</li>
<li>Archive a birth certificate.</li>
<li>Change the name on a birth certificate, which creates a new contract and archives the prior contract, all in the same offset.</li>
<li>Query a birth certificate which is done through PQS.</li>
</ul>
<p>Only contract creation and archival are shown in a following figure.</p>
<p>A snippet of the example follows:</p>
<pre class="code haskell literal-block">
<span class="name function">template</span><span class="whitespace"> </span><span class="keyword type">BirthCertificate</span><span class="whitespace">
  </span><span class="name">with</span><span class="whitespace">
    </span><span class="name">owner</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">Party</span><span class="whitespace">
    </span><span class="name">user_id</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">Text</span><span class="whitespace">
    </span><span class="name">firstName</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">Text</span><span class="whitespace">
    </span><span class="name">lastName</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">Text</span><span class="whitespace">
  </span><span class="keyword reserved">where</span><span class="whitespace">
    </span><span class="name">signatory</span><span class="whitespace"> </span><span class="name">owner</span><span class="whitespace">
    </span><span class="name">choice</span><span class="whitespace"> </span><span class="keyword type">BirthCertificateNameChange</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">ContractId</span><span class="whitespace"> </span><span class="keyword type">BirthCertificate</span><span class="whitespace">
      </span><span class="name">with</span><span class="whitespace">
        </span><span class="name">newFirstName</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">Text</span><span class="whitespace">
        </span><span class="name">newLastName</span><span class="whitespace"> </span><span class="keyword type">:</span><span class="whitespace"> </span><span class="keyword type">Text</span><span class="whitespace">
      </span><span class="name">controller</span><span class="whitespace"> </span><span class="name">owner</span><span class="whitespace">
      </span><span class="keyword reserved">do</span><span class="whitespace">
        </span><span class="name">create</span><span class="whitespace"> </span><span class="keyword type">BirthCertificate</span><span class="whitespace"> </span><span class="name">with</span><span class="whitespace">
          </span><span class="name">owner</span><span class="whitespace"> </span><span class="operator word">=</span><span class="whitespace"> </span><span class="name">owner</span><span class="whitespace">
          </span><span class="name">user_id</span><span class="whitespace"> </span><span class="operator word">=</span><span class="whitespace"> </span><span class="name">user_id</span><span class="whitespace">
          </span><span class="name">firstName</span><span class="whitespace"> </span><span class="operator word">=</span><span class="whitespace"> </span><span class="name">newFirstName</span><span class="whitespace">
          </span><span class="name">lastName</span><span class="whitespace"> </span><span class="operator word">=</span><span class="whitespace"> </span><span class="name">newLastName</span>
</pre>
<p>The birth certificate for Alice Citizen is created in offset #1, and it is active for all the shown offsets (the white horizontal line in a following figure) because it is not archived. The processing of this event starts at the same time of the event and completes before the next event occurs, which is the creation of the “Joe Bloggs” certificate. Joe Bloggs is renamed to Fred Bloggs in offset #3, so the original certificate is archived while the new certificate is created in offset #3, all within the same transaction (transaction IDs are not shown). Fred Bloggs' birth certificate is archived at offset #4. Bill Myers' certificate is created at offset #5, renamed to Bill Taylor in offset #6, renamed again to Bill Doe in offset #8, and renamed yet again to Bill Kirk in offset #9. The birth certificate for Jill Brown is created in offset #10.</p>
<p>Note the birth certificate for Jane Smith. It is created at offset #7. However, the processing of this event is very long, taking the same time as processing the other events at offsets #8, #9, and #10. The processing time is so long that the events of offset offsets #8, #9, and #10 are committed to the PQS database before Jane Smith's birth certificate's offset. That means that any PQS queries involving offsets #7 or later will be inconsistent because they don't include the results of offset #7. In this case, the queries of processed event data involve offsets #1 through #6 (the blue and yellow swimlanes). The watermark is at slot #6 (the yellow swimlane) because it is the last stable offset to have its event processed. There is a gap (the purple swimlane) in the data for the inflight events that are still being processed. Lastly, there are flushed events (offset #9 and #10) where events were quickly processed and the data is available to be queried, but it is not accurate. This is because offset #7 has not been completed, and its data is not in the database.</p>
<p>When the processing of offset #7 finishes, just as the event from #11 arrives (not shown), the watermark jumps to offset #10 because that is the last stable offset with its event processed.</p>
<object data="./images/event-chart.svg" type="image/svg+xml">A chart of selected events, showing the offsets, processed status, watermark, gap, and flushed</object>
<p>If you need to query consistent and stable data, always use the watermark as the most recent offset in the query. If a query is just a point-in-time value that does not have global consistency requirements, you don't need the watermark.</p>
</div>
</div>
<div class="section" id="external-unsynchronized-data">
<h2>External Unsynchronized Data</h2>
<p>The previous section discussed how PQS deals with internal synchronization in its programming model. This section examines the external synchronization of data and the precautions you need to take. This section describes the time lags that the PQS client application needs to be aware of when querying data. The following figures follow the conventions described in the section <a class="reference external" href="https://docs.daml.com/deploy-daml/infrastructure-architecture/high-availability/ha-and-scaling/implementing-ha.html#architecture-for-ha-and-scaling">Architecture for HA and Scaling</a>.</p>
<p>There are four cases to consider:</p>
<ul class="simple">
<li>The client application needs to retry an incomplete request, for example as the result of network issues.</li>
<li>PQS needs to catch up after a fresh install or restart.</li>
<li>There is a small delay for the ledger event to process.</li>
<li>A high availability PQS configuration does not have synchronized PQS instances.</li>
</ul>
<p>All distributed systems are subject to network issues. For example, networks that host the gRPC and JDBC query requests can both have intermittent issues. You must program the client application to retry for certain failures because the intermittent failure will heal itself. Most network outages are temporary, in which case the application can proceed without failing.</p>
<object data="./images/external-data.svg" type="image/svg+xml">A diagram showing queries using grpc and JDBC</object>
<p>If the PQS has been (re)started or is freshly installed, then the PQS needs to catch up to the participant node's generated events. Until that happens, the PQS will not have all the data available for querying.</p>
<p>There is a slight delay between when a participant node has finished the ledger processing and emitted an event and when the PQS finishes processing the event so that the result is available to query. For example, if the participant query performs a synchronous exercise and then immediately queries the PQS, it is remotely possible that PQS will not yet have the data. In this case, the client application needs to retry.</p>
<p>Lastly, a highly available production deployment (see the following figure) has multiple PQS instances, each of which processes events at slightly different rates. Since the PQS instances are not synchronized, they process events and commit the results to the database with different times. If the client application makes a query to the PQS service which is being serviced by PQS #A and then PQS #A fails, the client application retries after a timeout, which is then serviced by PQS #B. It is possible that PQS #B does not have its watermark at the same offset as PQS #A when PQS #A failed.</p>
<object data="./images/multiple-pqs.svg" type="image/svg+xml">A diagram showing a multiple PQS deployment</object>
</div>
</div>
<div class="section" id="install-and-start-pqs">
<h1>Install and start PQS</h1>
<div class="section" id="meet-prerequisites">
<h2>Meet prerequisites</h2>
<p>Here are the prerequisites to run PQS:</p>
<ul class="simple">
<li>A PostgreSQL database that can be reached from the PQS. Note that PQS uses the JSONB data type for storing JSON data, which requires Postgres versions 11 through 16.</li>
<li>An empty database (recommended) to avoid schema and table collisions.</li>
<li>Daml ledger as the source of events. m/TLS is supported for the participant node ledger API. Alternatively, it can run against the <tt class="docutils literal">Sandbox</tt>.</li>
<li>Installation of <a class="reference external" href="https://docs.daml.com/getting-started/installation.html#install-daml-enterprise">The Daml Enterprise SDK</a>.</li>
</ul>
</div>
<div class="section" id="deploy-the-scribe-component">
<h2>Deploy the Scribe component</h2>
<p>The PQS consists of two components: the PostgreSQL database and a ledger component called <em>Scribe</em>, as shown in the figure. Scribe is packaged as a Java JAR file and is available from <a class="reference external" href="https://digitalasset.jfrog.io/ui/native/scribe">the Digital Asset Artifactory path</a>.</p>
<object data="./images/scribe.svg" type="image/svg+xml">A diagram showing the components of the Participant Query Store</object>
</div>
<div class="section" id="connect-the-pqs-to-a-ledger">
<h2>Connect the PQS to a ledger</h2>
<p>To connect to the participant node ledger, provide separate address and port parameters. For example, you could specify <tt class="docutils literal"><span class="pre">--host</span> 10.1.1.10 <span class="pre">--port</span> 6865</tt>, or in short form <tt class="docutils literal"><span class="pre">-h</span> 10.1.1.168 <span class="pre">-p</span> 6865</tt>.</p>
<p>You do not need to pass the default host <tt class="docutils literal">localhost</tt> and default port <tt class="docutils literal">6865</tt>.</p>
<p>To connect to a participant node, you might need to provide TLS certificates. To see options for this, refer to the output of the <tt class="docutils literal"><span class="pre">--help</span></tt> command.</p>
</div>
<div class="section" id="authorize-pqs">
<h2>Authorize PQS</h2>
<p>If you are running PQS against a participant node's ledger API that verifies authorization, you must provide credentials for the <a class="reference external" href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/client-credentials-flow">OAuth Client Credentials Flow</a>. For example:</p>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>ledger<span class="whitespace"> </span>postgres-document<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">    </span>--source-ledger-auth<span class="whitespace"> </span>OAuth<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">    </span>--pipeline-oauth-clientid<span class="whitespace"> </span>my_client_id<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">    </span>--pipeline-oauth-clientsecret<span class="whitespace"> </span>deadbeef<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">    </span>--pipeline-oauth-cafile<span class="whitespace"> </span>ca.crt<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">    </span>--pipeline-oauth-endpoint<span class="whitespace"> </span>https://my-auth-server/token
</pre>
<p>The type of access token that PQS expects is Audience / Scope based tokens (see “<a class="reference external" href="https://docs.daml.com/app-dev/authorization.html#user-access-tokens">User Access Tokens</a>” for more information).</p>
<p>Scribe will obtain tokens from the Authorization Server on startup, and it will reauthenticate before the token expires. If Scribe fails authorization, it will terminate with an error for the service orchestration infrastructure to respond appropriately.</p>
<p>If you are not authenticated, there is no user to connect to a list of
<tt class="docutils literal">readAs</tt> parties, so you must specify the parties using the
<tt class="docutils literal"><span class="pre">-pipeline-parties</span></tt> argument. This argument acts as a filter, restricting
the data to only what's visible to the supplied list of party identifiers.</p>
<p>The authentication of PQS needs to match the participant nodes (PN) setup. For
example, if PQS is run with authentication by setting OAuth and the PN is not
configured to use authentication, then an error will result. The error will
have a message like <tt class="docutils literal">requests with an empty <span class="pre">user-id</span> are only supported if
there is an authenticated user</tt>.</p>
</div>
<div class="section" id="set-up-postgresql">
<h2>Set up PostgreSQL</h2>
<p>To connect the database, create a PostgreSQL database with three users:</p>
<ul class="simple">
<li><strong>Ops</strong>: Provides a way for database administrators or Scribe to access DDL for schema creation and general maintenance.</li>
<li><strong>Writer</strong>: Allows Scribe to connect, such as during &quot;pipeline&quot; operations of writing the ledger.</li>
<li><strong>Reader</strong>: Supports all other users.</li>
</ul>
</div>
<div class="section" id="connect-to-the-pqs-postgresql-datastore">
<h2>Connect to the PQS PostgreSQL datastore</h2>
<p>The database connection is handled by the JDBC API, so you need to provide the following (all have defaults):</p>
<ul class="simple">
<li>Hostname</li>
<li>Port number</li>
<li>Username</li>
<li>Password</li>
</ul>
<p>The following example connects to a PostgreSQL instance running on localhost on the default port, with a user for which Postgres has not set a password and a database called <tt class="docutils literal">daml_pqs</tt>. This is a typical setup on a developer machine with a default PostgreSQL install.</p>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>ledger<span class="whitespace"> </span>postgres-document<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">     </span>--target-postgres-database<span class="whitespace"> </span>daml_pqs
</pre>
<p>The next example connects to a database on host <tt class="docutils literal">192.168.1.12</tt>, listening on port <tt class="docutils literal">5432</tt>. The database is called <tt class="docutils literal">daml_pqs</tt>.</p>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>ledger<span class="whitespace"> </span>postgres-document<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">     </span>--target-postgres-host<span class="whitespace"> </span><span class="literal number">192</span>.168.1.12<span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">     </span>--target-postgres-database<span class="whitespace"> </span>daml_pqs
</pre>
</div>
<div class="section" id="logging">
<h2>Logging</h2>
<p>By default, the PQS logs to <tt class="docutils literal">stderr</tt>, with <tt class="docutils literal">INFO</tt> verbose level. To change the level, use the <tt class="docutils literal"><span class="pre">--logger-level</span> enum</tt> option, as in the example <tt class="docutils literal"><span class="pre">--logger-level</span> Trace</tt>.</p>
</div>
<div class="section" id="using-command-line-options">
<h2>Using command line options</h2>
<p>You can discover commands and parameters through the embedded <tt class="docutils literal"><span class="pre">--help</span></tt> (remember to include <tt class="docutils literal">pipeline</tt> before <tt class="docutils literal"><span class="pre">--help</span></tt>), as shown in the following example.</p>
<pre class="code bash literal-block">
./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>--help<span class="whitespace">
</span>Usage:<span class="whitespace"> </span>scribe<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>SOURCE<span class="whitespace"> </span>TARGET<span class="whitespace"> </span><span class="operator">[</span>OPTIONS<span class="operator">]</span><span class="whitespace">

</span>Initiate<span class="whitespace"> </span>continuous<span class="whitespace"> </span>ledger<span class="whitespace"> </span>data<span class="whitespace"> </span><span class="name builtin">export</span><span class="whitespace">

</span>Available<span class="whitespace"> </span>sources:<span class="whitespace">
  </span>ledger<span class="whitespace">    </span>Daml<span class="whitespace"> </span>ledger<span class="whitespace">

</span>Available<span class="whitespace"> </span>targets:<span class="whitespace">
  </span>postgres-document<span class="whitespace">    </span>Postgres<span class="whitespace"> </span>database<span class="whitespace"> </span><span class="operator">(</span>w/<span class="whitespace"> </span>document<span class="whitespace"> </span>payload<span class="whitespace"> </span>representation<span class="operator">)</span><span class="whitespace">

</span>Options:<span class="whitespace">
  </span>--config<span class="whitespace"> </span>file<span class="whitespace">                              </span>Path<span class="whitespace"> </span>to<span class="whitespace"> </span>configuration<span class="whitespace"> </span>overrides<span class="whitespace"> </span>via<span class="whitespace"> </span>an<span class="whitespace"> </span>external<span class="whitespace"> </span>HOCON<span class="whitespace"> </span>file<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-datasource<span class="whitespace"> </span>enum<span class="whitespace">                 </span>Ledger<span class="whitespace"> </span>API<span class="whitespace"> </span>service<span class="whitespace"> </span>to<span class="whitespace"> </span>use<span class="whitespace"> </span>as<span class="whitespace"> </span>data<span class="whitespace"> </span><span class="name builtin">source</span><span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>TransactionStream<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-oauth-clientid<span class="whitespace"> </span>string<span class="whitespace">           </span>Client<span class="whitespace"> </span>identifier<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-oauth-accesstoken<span class="whitespace"> </span>string<span class="whitespace">        </span>Access<span class="whitespace"> </span>token<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-oauth-parameters<span class="whitespace"> </span>map<span class="whitespace">            </span>Custom<span class="whitespace"> </span>parameters<span class="whitespace">
  </span>--pipeline-oauth-cafile<span class="whitespace"> </span>file<span class="whitespace">               </span>Trusted<span class="whitespace"> </span>Certificate<span class="whitespace"> </span>Authority<span class="whitespace"> </span><span class="operator">(</span>CA<span class="operator">)</span><span class="whitespace"> </span>certificate<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-oauth-endpoint<span class="whitespace"> </span>uri<span class="whitespace">              </span>Token<span class="whitespace"> </span>endpoint<span class="whitespace"> </span>URL<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-oauth-clientsecret<span class="whitespace"> </span>string<span class="whitespace">       </span>Client<span class="whitespace"> </span>secret<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-filter-parties<span class="whitespace"> </span>string<span class="whitespace">           </span>Filter<span class="whitespace"> </span>expression<span class="whitespace"> </span>determining<span class="whitespace"> </span>Daml<span class="whitespace"> </span>party<span class="whitespace"> </span>identifiers<span class="whitespace"> </span>to<span class="whitespace"> </span>filter<span class="whitespace"> </span>on<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>*<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-filter-metadata<span class="whitespace"> </span>string<span class="whitespace">          </span>Filter<span class="whitespace"> </span>expression<span class="whitespace"> </span>determining<span class="whitespace"> </span>which<span class="whitespace"> </span>templates<span class="whitespace"> </span>and<span class="whitespace"> </span>interfaces<span class="whitespace"> </span>to<span class="whitespace"> </span>capture<span class="whitespace"> </span>metadata<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>!*<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-filter-contracts<span class="whitespace"> </span>string<span class="whitespace">         </span>Filter<span class="whitespace"> </span>expression<span class="whitespace"> </span>determining<span class="whitespace"> </span>which<span class="whitespace"> </span>templates<span class="whitespace"> </span>and<span class="whitespace"> </span>interfaces<span class="whitespace"> </span>to<span class="whitespace"> </span>include<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>*<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-ledger-start<span class="whitespace"> </span><span class="operator">[</span>enum<span class="whitespace"> </span><span class="punctuation">|</span><span class="whitespace"> </span>string<span class="operator">]</span><span class="whitespace">    </span>Start<span class="whitespace"> </span>offset<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>Latest<span class="operator">)</span><span class="whitespace">
  </span>--pipeline-ledger-stop<span class="whitespace"> </span><span class="operator">[</span>enum<span class="whitespace"> </span><span class="punctuation">|</span><span class="whitespace"> </span>string<span class="operator">]</span><span class="whitespace">     </span>Stop<span class="whitespace"> </span>offset<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>Never<span class="operator">)</span><span class="whitespace">
  </span>--health-port<span class="whitespace"> </span>int<span class="whitespace">                          </span>HTTP<span class="whitespace"> </span>port<span class="whitespace"> </span>to<span class="whitespace"> </span>use<span class="whitespace"> </span>to<span class="whitespace"> </span>expose<span class="whitespace"> </span>application<span class="whitespace"> </span>health<span class="whitespace"> </span>info<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span><span class="literal number">8080</span><span class="operator">)</span><span class="whitespace">
  </span>--logger-level<span class="whitespace"> </span>enum<span class="whitespace">                        </span>Log<span class="whitespace"> </span>level<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>Info<span class="operator">)</span><span class="whitespace">
  </span>--logger-mappings<span class="whitespace"> </span>map<span class="whitespace">                      </span>Custom<span class="whitespace"> </span>mappings<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>log<span class="whitespace"> </span>levels<span class="whitespace">
  </span>--logger-format<span class="whitespace"> </span>enum<span class="whitespace">                       </span>Log<span class="whitespace"> </span>output<span class="whitespace"> </span>format<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>Plain<span class="operator">)</span><span class="whitespace">
  </span>--logger-pattern<span class="whitespace"> </span><span class="operator">[</span>enum<span class="whitespace"> </span><span class="punctuation">|</span><span class="whitespace"> </span>string<span class="operator">]</span><span class="whitespace">           </span>Log<span class="whitespace"> </span>pattern<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>Plain<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-host<span class="whitespace"> </span>string<span class="whitespace">              </span>Postgres<span class="whitespace"> </span>host<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>localhost<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-tls-mode<span class="whitespace"> </span>enum<span class="whitespace">            </span>SSL<span class="whitespace"> </span>mode<span class="whitespace"> </span>required<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>Postgres<span class="whitespace"> </span>connectivity<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>Disable<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-tls-cert<span class="whitespace"> </span>file<span class="whitespace">            </span>Client<span class="whitespace"> </span>certificate<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-tls-key<span class="whitespace"> </span>file<span class="whitespace">             </span>Client<span class="whitespace"> </span>private<span class="whitespace"> </span>key<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-tls-cafile<span class="whitespace"> </span>file<span class="whitespace">          </span>Trusted<span class="whitespace"> </span>Certificate<span class="whitespace"> </span>Authority<span class="whitespace"> </span><span class="operator">(</span>CA<span class="operator">)</span><span class="whitespace"> </span>certificate<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-maxconnections<span class="whitespace"> </span>int<span class="whitespace">       </span>Maximum<span class="whitespace"> </span>number<span class="whitespace"> </span>of<span class="whitespace"> </span>JDBC<span class="whitespace"> </span>connections<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span><span class="literal number">16</span><span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-password<span class="whitespace"> </span>string<span class="whitespace">          </span>Postgres<span class="whitespace"> </span>user<span class="whitespace"> </span>password<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>********<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-username<span class="whitespace"> </span>string<span class="whitespace">          </span>Postgres<span class="whitespace"> </span>user<span class="whitespace"> </span>name<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>postgres<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-database<span class="whitespace"> </span>string<span class="whitespace">          </span>Postgres<span class="whitespace"> </span>database<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>postgres<span class="operator">)</span><span class="whitespace">
  </span>--target-postgres-port<span class="whitespace"> </span>int<span class="whitespace">                 </span>Postgres<span class="whitespace"> </span>port<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span><span class="literal number">5432</span><span class="operator">)</span><span class="whitespace">
  </span>--target-schema-autoapply<span class="whitespace"> </span>boolean<span class="whitespace">          </span>Apply<span class="whitespace"> </span>metadata<span class="whitespace"> </span>inferred<span class="whitespace"> </span>schema<span class="whitespace"> </span>on<span class="whitespace"> </span>startup<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span><span class="name builtin">true</span><span class="operator">)</span><span class="whitespace">
  </span>--source-ledger-host<span class="whitespace"> </span>string<span class="whitespace">                </span>Ledger<span class="whitespace"> </span>API<span class="whitespace"> </span>host<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>localhost<span class="operator">)</span><span class="whitespace">
  </span>--source-ledger-auth<span class="whitespace"> </span>enum<span class="whitespace">                  </span>Authorisation<span class="whitespace"> </span>mode<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span>NoAuth<span class="operator">)</span><span class="whitespace">
  </span>--source-ledger-tls-cafile<span class="whitespace"> </span>file<span class="whitespace">            </span>Trusted<span class="whitespace"> </span>Certificate<span class="whitespace"> </span>Authority<span class="whitespace"> </span><span class="operator">(</span>CA<span class="operator">)</span><span class="whitespace"> </span>certificate<span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--source-ledger-tls-cert<span class="whitespace"> </span>file<span class="whitespace">              </span>Client<span class="whitespace"> </span>certificate<span class="whitespace"> </span><span class="operator">(</span>leave<span class="whitespace"> </span>empty<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>embedded<span class="whitespace"> </span>into<span class="whitespace"> </span>private<span class="whitespace"> </span>key<span class="whitespace"> </span>file<span class="operator">)</span><span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--source-ledger-tls-key<span class="whitespace"> </span>file<span class="whitespace">               </span>Client<span class="whitespace"> </span>private<span class="whitespace"> </span>key<span class="whitespace"> </span><span class="operator">(</span>leave<span class="whitespace"> </span>empty<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>server-only<span class="whitespace"> </span>TLS<span class="operator">)</span><span class="whitespace"> </span><span class="operator">(</span>optional<span class="operator">)</span><span class="whitespace">
  </span>--source-ledger-port<span class="whitespace"> </span>int<span class="whitespace">                   </span>Ledger<span class="whitespace"> </span>API<span class="whitespace"> </span>port<span class="whitespace"> </span><span class="operator">(</span>default:<span class="whitespace"> </span><span class="literal number">6865</span><span class="operator">)</span>
</pre>
<p>For more help, use the command:</p>
<pre class="code bash literal-block">
./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>--help-verbose
</pre>
<p>Use a <tt class="docutils literal"><span class="pre">--config</span></tt> file to define multiple options or reflect an infrastructure-as-code approach. Here's an example configuration file:</p>
<pre class="code none literal-block">
{
   health.port = 8080

   logger {
      # level = &quot;Debug&quot;
      format = &quot;Plain&quot;
      pattern = &quot;Plain&quot;
   }

   pipeline {
      datasource = &quot;TransactionStream&quot;

      filter {
         parties = &quot;*&quot;
         metadata = &quot;!*&quot;
         contracts = &quot;*&quot;
      }

      ledger {
         start = &quot;Latest&quot;
         stop = &quot;Never&quot;
      }
   }

   source {
      ledger {
         host = &quot;canton&quot;
         port = 10011
      }
   }

   target {
      postgres {
         host = &quot;pqs-postgres&quot;
         port = 5432
         username = &quot;postgres&quot;
         database = &quot;postgres&quot;
         maxConnections = 16
      }
   }
   schema.autoApply = true
}
</pre>
<p>Following is an example of a basic command to run PQS to extract all data, including exercises, for a party with the display name Alice. You can replace the argument values with those that match your environment.</p>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>ledger<span class="whitespace"> </span>postgres-document<span class="whitespace"> </span><span class="literal string escape">\
</span>--pipeline-parties<span class="whitespace"> </span>Alice::12209942561b94adc057995f9ffca5a0b974953e72ba25e0eb158e05c801149639b9<span class="whitespace"> </span><span class="literal string escape">\
</span>--pipeline-datasource<span class="whitespace"> </span>TransactionTreeStream<span class="whitespace"> </span><span class="literal string escape">\
</span>--source-ledger-host<span class="whitespace"> </span>localhost<span class="whitespace"> </span><span class="literal string escape">\
</span>--source-ledger-port<span class="whitespace"> </span><span class="literal number">6865</span><span class="whitespace"> </span><span class="literal string escape">\
</span>--target-postgres-host<span class="whitespace"> </span>localhost<span class="whitespace"> </span><span class="literal string escape">\
</span>--target-postgres-port<span class="whitespace"> </span><span class="literal number">5432</span><span class="whitespace"> </span><span class="literal string escape">\
</span>--target-postgres-database<span class="whitespace"> </span>postgres<span class="whitespace"> </span><span class="literal string escape">\
</span>--target-postgres-username<span class="whitespace"> </span>postgres<span class="whitespace"> </span><span class="literal string escape">\
</span>--target-postgres-password<span class="whitespace"> </span>postgres
</pre>
<p>NOTE: Only <tt class="docutils literal"><span class="pre">postgres-document</span></tt> is currently implemented, with <tt class="docutils literal"><span class="pre">postgres-relational</span></tt> to follow soon.</p>
<p>The <tt class="docutils literal"><span class="pre">-pipeline-ledger-start</span></tt> argument is an enum with the following possible values:</p>
<ul class="simple">
<li><tt class="docutils literal">Latest</tt>: Use the latest offset that is known or resume where it left off. This is the default behavior, where streaming starts at the latest known end. The first time you start, this will result in PQS calling <tt class="docutils literal">ActiveContractService</tt> to get a state snapshot, which it will load into the <tt class="docutils literal">_creates</tt> table. It will then start streaming creates, archives, and (optionally) exercises from the offset of that <tt class="docutils literal">ActiveContractService</tt>. When you restart PQS, it will start from the point it last left off. You should always use this mode on restart.</li>
<li><tt class="docutils literal">Genesis</tt>: Use the first original offset of the ledger. This causes PQS to try to start from offset <tt class="docutils literal">0</tt>. It allows you to load historic creates, archives or (optionally) exercises from a ledger that already has data on it. If you try to restart on an already populated database in this mode, PQS will rewrite data if it needs to.</li>
<li><tt class="docutils literal">Oldest</tt>: Use the oldest available (unpruned) offset on the ledger or resume where it left off.</li>
</ul>
<p>PQS is able to start and finish at prescribed ledger offsets, specified by the
arguments <tt class="docutils literal"><span class="pre">--pipeline-ledger-start</span></tt> and <tt class="docutils literal"><span class="pre">--pipeline-ledger-stop</span></tt>. The
<tt class="docutils literal">./scribe.jar pipeline <span class="pre">--help-verbose</span></tt> command provides extensive help
information.</p>
<p>The <tt class="docutils literal"><span class="pre">--pipeline-filter</span> string</tt> option needs a filter expression to determine
which templates and interfaces to include. A filter expression is a simple wildcard
inclusion statement with basic Boolean logic, where whitespace is ignored. Below are some examples:</p>
<ul class="simple">
<li><tt class="docutils literal">*</tt>: everything, which is the default</li>
<li><tt class="docutils literal">a.b.c.Bar</tt>: just this one fully qualified name</li>
<li><tt class="docutils literal">a.b.c.*</tt>: all under the <tt class="docutils literal">a.b.c</tt> namespace</li>
<li><tt class="docutils literal"><span class="pre">deadbeef..:a.b.c.Foo</span></tt> just this one fully qualified name from this specific package ID</li>
<li><tt class="docutils literal">!a.b.c.Bar</tt>: everything except this fully qualified name</li>
<li><tt class="docutils literal">a.b.c.Foo &amp; a.b.c.Bar</tt>: this is an error because it can't be both</li>
<li><tt class="docutils literal">(a.b.c.Foo | a.b.c.Bar)</tt>: these two fully qualified names</li>
<li><tt class="docutils literal">(a.b.c.* &amp; !(a.b.c.Foo | a.b.c.Bar) | g.e.f.Baz)</tt>: everything in <tt class="docutils literal">a.b.c</tt> except for <tt class="docutils literal">Foo</tt> and <tt class="docutils literal">Bar</tt>, and also include <tt class="docutils literal">g.e.f.Baz</tt></li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">--pipeline-parties</span></tt> option supports the same filter expressions as the
<tt class="docutils literal"><span class="pre">--pipeline-filter</span></tt>. So to filter for two parties <tt class="docutils literal"><span class="pre">alice::abc123...</span></tt> and
<tt class="docutils literal"><span class="pre">bob::def567...</span></tt>, you could write <tt class="docutils literal"><span class="pre">--pipeline-parties=&quot;(alice*</span> | <span class="pre">bob*)&quot;</span></tt>.
If you want to specify a specific party, include the hash behind the party
hint (such as
<tt class="docutils literal"><span class="pre">Alice_1::122055fc4b190e3ff438587b699495a4b6388e911e2305f7e013af160f49a76080ab</span></tt>).</p>
<p>Please note that the separator is a pipe character (<tt class="docutils literal">|</tt>) instead of a comma.</p>
<p>Brackets are unnecessary for simple expressions. A simple list is
<tt class="docutils literal"><span class="pre">--pipeline-parties=&quot;Alice_1::122055fc4b190e3ff438587b699495a4b6388e911e2305f7e013af160f49a76080ab</span>
|
<span class="pre">Alice_2::122053933e4803c2995e41faa8a29981ca0d1faf6b4ffbf917ba1edd0db133acb634</span>
| <span class="pre">Peter-1::358400000000000000000000000</span></tt> Specifying the parties in a short
form can be done by using the <tt class="docutils literal">*</tt> as a wildcard. For example,
<tt class="docutils literal"><span class="pre">--pipeline-parties=&quot;Alice*</span> | *358400000000000000000000000&quot;</tt> selects
<tt class="docutils literal">Alice_1</tt>, <tt class="docutils literal">Alice_2</tt>, and <tt class="docutils literal"><span class="pre">Peter-1</span></tt>.</p>
<p>More advanced expressions can make use of brackets, such as
<tt class="docutils literal"><span class="pre">--pipeline-parties=&quot;Alice*</span> | Bob* | (participant* &amp; <span class="pre">!(participant3::*))&quot;</span></tt>.</p>
</div>
<div class="section" id="handle-configuration-changes">
<h2>Handle configuration changes</h2>
<p>PQS initializes its behavior on startup by reading its configuration files.
It currently doesn't support dynamic configuration updates, so making a
configuration change (such as adding a new party, new template, or new
interface) requires stopping PQS, modifying its configuration, and then
starting PQS. On startup, PQS will read the updated configuration.</p>
<p>When the configuration changes, the default is that PQS will not go back in
time (older offset) but only move forward in time (current watermark offset
and newer). If the database is dropped, then PQS can be started at the
oldest, unpruned offset of the participant node and use the participant node's
history to extract the events based on the updated configuration.</p>
</div>
</div>
<div class="section" id="pqs-development">
<h1>PQS development</h1>
<div class="section" id="offset-management-for-querying">
<h2>Offset management for querying</h2>
<p>The following functions control the temporal perspective of the ledger,
considering how you wish to consider time as a scope for your queries.
You may wish to:</p>
<ul class="simple">
<li>Effectively ignore time; simply query the <em>latest available</em> state</li>
<li>Query the state of the ledger at a specific time in history</li>
<li>Query the ledger events across a time range -- an audit trail, for example</li>
<li>Query the ledger in a way that preserves consistency with other
interactions you have had with the ledger (reader or writer)</li>
</ul>
<p>The following functions allow you to control the temporal scope of the
ledger, which establishes the context in which subsequent queries in the
PostgreSQL session will execute:</p>
<ul class="simple">
<li><tt class="docutils literal">set_latest(offset)</tt>: nominates the offset of the latest data to
include in observing the ledger. If NULL, it uses the very latest
available. The actual offset that will be used is returned. If the
supplied offset is beyond what is available, an error occurs.</li>
<li><tt class="docutils literal">set_latest_minimum(offset)</tt>: provides the minimum offset that
should be used, but a more recent offset will always be chosen.
Returns an error if the nominated offset is not yet available.
The function returns the actual offset used.</li>
<li><tt class="docutils literal">set_oldest(offset)</tt>: nominates the offset of the oldest events to
include in the query scope. If <tt class="docutils literal">NULL</tt>, it uses the oldest available.
The function returns the actual offset used. If the supplied offset is
beyond what is available, an error occurs.</li>
<li><tt class="docutils literal">get_offset(time)</tt>: provides a helper function to determine the offset of a
given <tt class="docutils literal">time</tt> (or interval prior to now).</li>
</ul>
<p>Under this temporal scope, the following <a class="reference external" href="https://www.postgresql.org/docs/current/queries-table-expressions.html">table
functions</a>
allow access to the ledger and are used directly in queries. They
can be used in a similar manner to tables or views and allow
users to focus on the data they wish to query, with the impact of
offsets removed.</p>
<ul class="simple">
<li><tt class="docutils literal">active(name)</tt>: active instances of the target contracts/interfaces
that existed at the time of the latest offset</li>
<li><tt class="docutils literal">creates(name)</tt>: create events that occurred between the oldest and
latest offset</li>
<li><tt class="docutils literal">archives(name)</tt>: archive events that occurred between the oldest
and latest offset</li>
<li><tt class="docutils literal">exercises(name)</tt>: exercise events that occurred between the oldest
and latest offset</li>
</ul>
<p>The functions allow the user to focus on the
templates/interfaces/choices they wish to query, without concern for
<a class="reference external" href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html#:~:text=maximum%20identifier%20length%20is%2063%20bytes">PostgreSQL name
limits</a>.
The <tt class="docutils literal">name</tt> parameter can be used with or without the package
specified:</p>
<ul class="simple">
<li>Fully qualified:
<tt class="docutils literal"><span class="pre">&lt;package-id&gt;:&lt;module&gt;:&lt;template|interface|choice&gt;</span></tt></li>
<li>Partially qualified: <tt class="docutils literal"><span class="pre">&lt;module&gt;:&lt;template|interface|choice&gt;</span></tt></li>
</ul>
</div>
<div class="section" id="query-patterns">
<h2>Query patterns</h2>
<p>Several common ways to use the table functions are described in the following sections:</p>
<ul class="simple">
<li>Use the most recent available state of the ledger</li>
<li>Query the ledger using a point in time</li>
<li>Query the ledger from a fixed offset</li>
<li>Set the oldest offset to consider</li>
<li>Set the oldest and latest offset by time value</li>
<li>Set a minimum offset for consistency</li>
<li>Use the widest available offset range for querying</li>
</ul>
<p>These can be combined or altered for the purpose of the query.</p>
<div class="section" id="use-the-most-recent-available-state-of-the-ledger">
<h3>Use the most recent available state of the ledger</h3>
<p>In this pattern, a user wants to query the most recent available state of the ledger. This user
treats the ledger Active Contract Set as a virtual database table and is not
concerned with offsets because the latest result is desired.</p>
<p>This user wants to query the (latest) state of the ledger
without consideration for offsets. Querying is inherently limited to one
data source, as the user has no control over the actual offset that will
be used.</p>
<p>In this scenario, the user wishes to query all Daml templates of <tt class="docutils literal">User</tt>
within the <tt class="docutils literal">Test.User</tt> templates, where the user is not an
administrator:</p>
<pre class="code sql literal-block">
<span class="name">set_offset_latest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace">
  </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">active</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="whitespace">
  </span><span class="keyword">WHERE</span><span class="whitespace"> </span><span class="keyword">NOT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="literal string symbol">&quot;admin&quot;</span><span class="punctuation">;</span>
</pre>
<p>By using PostgreSQL’s JSONB querying capabilities, you can join with the
related <tt class="docutils literal">Alias</tt> template to provide an overview of all users and their
aliases:</p>
<pre class="code sql literal-block">
<span class="name">set_latest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="operator">*</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="keyword">alias</span><span class="punctuation">.</span><span class="operator">*</span><span class="whitespace">
  </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">active</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="whitespace">
    </span><span class="keyword">LEFT</span><span class="whitespace"> </span><span class="keyword">JOIN</span><span class="whitespace"> </span><span class="name">active</span><span class="punctuation">(</span><span class="literal string single">'Test.User:Alias'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="keyword">alias</span><span class="whitespace">
      </span><span class="keyword">ON</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="name">payload</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'user_id'</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">alias</span><span class="punctuation">.</span><span class="name">payload</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'user_id'</span><span class="punctuation">;</span>
</pre>
<p>Historical events can also be accessed; by default all the history in
the datastore is available for querying. The following query returns
the data associated with all <tt class="docutils literal">User</tt> contracts that were archived in
the available history:</p>
<pre class="code sql literal-block">
<span class="name">set_latest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="name">set_oldest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="keyword">c</span><span class="punctuation">.</span><span class="operator">*</span><span class="whitespace">
  </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">archives</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="name">a</span><span class="whitespace">
    </span><span class="keyword">JOIN</span><span class="whitespace"> </span><span class="keyword">create</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="keyword">c</span><span class="whitespace"> </span><span class="keyword">USING</span><span class="whitespace"> </span><span class="name">contract_id</span><span class="punctuation">;</span>
</pre>
</div>
<div class="section" id="query-the-ledger-using-a-point-in-time">
<h3>Query the ledger using a point in time</h3>
<p>In this pattern, a report writer wants to query the ledger as of a known historical point in
time to ensure that consistent data is provided regardless of where the
ledger subsequently evolved.</p>
<p>This user can obtain a point-in-time view of the ledger to see all
non-admin <tt class="docutils literal">User</tt> templates that were active at that point in time:</p>
<pre class="code sql literal-block">
<span class="name">set_latest</span><span class="punctuation">(</span><span class="name">get_offset</span><span class="punctuation">(</span><span class="literal string single">'2020-01-01 00:00:00+0'</span><span class="punctuation">));</span><span class="whitespace">
</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="operator">*</span><span class="whitespace">
  </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">active</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="whitespace">
  </span><span class="keyword">WHERE</span><span class="whitespace"> </span><span class="keyword">NOT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="keyword">admin</span><span class="punctuation">;</span>
</pre>
<p>The user can then query the history of the ledger to see
how many aliases have existed for each of these users who were
active at the snapshot time:</p>
<pre class="code sql literal-block">
<span class="name">set_latest</span><span class="punctuation">(</span><span class="name">get_offset</span><span class="punctuation">(</span><span class="literal string single">'2020-01-01 00:00:00+0'</span><span class="punctuation">));</span><span class="whitespace">
</span><span class="name">set_oldest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="keyword">WITH</span><span class="whitespace"> </span><span class="literal string symbol">&quot;users&quot;</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="whitespace">
  </span><span class="keyword">SELECT</span><span class="whitespace">  </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="operator">*</span><span class="whitespace">
    </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">active</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="whitespace">
    </span><span class="keyword">WHERE</span><span class="whitespace"> </span><span class="keyword">NOT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="keyword">admin</span><span class="whitespace">
</span><span class="punctuation">)</span><span class="whitespace">
</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="name">user_id</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="keyword">COUNT</span><span class="punctuation">(</span><span class="keyword">alias</span><span class="punctuation">.</span><span class="operator">*</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="name">alias_count</span><span class="whitespace">
  </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">active</span><span class="punctuation">(</span><span class="literal string single">'Test.User:User'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="whitespace">
    </span><span class="keyword">JOIN</span><span class="whitespace"> </span><span class="keyword">create</span><span class="punctuation">(</span><span class="literal string single">'Test.User:Alias'</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="keyword">alias</span><span class="whitespace">
      </span><span class="keyword">ON</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="name">payload</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'user_id'</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">alias</span><span class="punctuation">.</span><span class="name">payload</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'user_id'</span><span class="whitespace">
  </span><span class="keyword">WHERE</span><span class="whitespace"> </span><span class="keyword">NOT</span><span class="whitespace"> </span><span class="literal string symbol">&quot;user&quot;</span><span class="punctuation">.</span><span class="keyword">admin</span><span class="punctuation">;</span>
</pre>
</div>
<div class="section" id="query-the-ledger-from-a-fixed-offset">
<h3>Query the ledger from a fixed offset</h3>
<p>In this pattern, an automation user wants to query from fixed known offsets and wants to
write a query in the same, familiar way.</p>
<pre class="code sql literal-block">
<span class="comment single">-- fails if the datastore has not yet reached the given offset
</span><span class="name">set_latest</span><span class="punctuation">(</span><span class="literal string symbol">&quot;00000001250&quot;</span><span class="punctuation">);</span>
</pre>
<p>The queries observe active contracts from the given
offset. The example queries presented above are unchanged.</p>
</div>
<div class="section" id="set-the-oldest-offset-to-consider">
<h3>Set the oldest offset to consider</h3>
<p>In this pattern, a user wants to present a limited amount of history to users.</p>
<p>If readers wish to limit the event history, they can call:</p>
<pre class="code sql literal-block">
<span class="comment single">-- fails if this offset has already been pruned
</span><span class="name">set_oldest</span><span class="punctuation">(</span><span class="literal string symbol">&quot;00000000500&quot;</span><span class="punctuation">);</span>
</pre>
<p>This adjustment in scope does not affect the example queries presented
above.</p>
</div>
<div class="section" id="set-the-oldest-and-latest-offset-by-time-value">
<h3>Set the oldest and latest offset by time value</h3>
<p>In this pattern, a user wants to present a time-based view to users to provide reports
based on point-in-time rather than offsets:</p>
<pre class="code sql literal-block">
<span class="name">set_latest</span><span class="punctuation">(</span><span class="name">get_offset</span><span class="punctuation">(</span><span class="keyword">TIMESTAMP</span><span class="whitespace"> </span><span class="literal string single">'2020-03-13 00:00:00+0'</span><span class="punctuation">))</span><span class="whitespace">
</span><span class="name">set_oldest</span><span class="punctuation">(</span><span class="name">get_offset</span><span class="punctuation">(</span><span class="name builtin">INTERVAL</span><span class="whitespace"> </span><span class="literal string single">'14 days'</span><span class="punctuation">));</span><span class="whitespace"> </span><span class="comment single">-- history of the past 14 days</span>
</pre>
</div>
<div class="section" id="set-a-minimum-offset-for-consistency">
<h3>Set a minimum offset for consistency</h3>
<p>For this pattern, a website user wants to query active contracts after
completing a command (write) which updated the ledger. The user
does not want to see a version of the ledger prior to the command
being executed.</p>
<pre class="code sql literal-block">
<span class="comment single">-- The user just executed a command at offset #00000001350.
-- This function call will fail if the datastore has not yet reached this offset, in order to provide consistent reads.
-- If it has an even more recent offset (eg. 00000001355) - this will be used instead.
</span><span class="name">set_latest_minimum</span><span class="punctuation">(</span><span class="literal string symbol">&quot;00000001350&quot;</span><span class="punctuation">);</span>
</pre>
</div>
<div class="section" id="use-the-widest-available-offset-range-for-querying">
<h3>Use the widest available offset range for querying</h3>
<p>In this pattern, a user wants to enquire about the offset availability of the datastore.</p>
<p>In this example, the user asks for the very latest and oldest offsets available, and those offsets are returned:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span><span class="whitespace"> </span><span class="name">set_latest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="name">latest_offset</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">set_oldest</span><span class="punctuation">(</span><span class="keyword">NULL</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">AS</span><span class="whitespace"> </span><span class="name">oldest_offset</span><span class="punctuation">;</span>
</pre>
</div>
</div>
<div class="section" id="advanced-querying-topics">
<h2>Advanced querying topics</h2>
<div class="section" id="reading">
<h3>Reading</h3>
<p>There are two distinct approaches for querying ledger
data in the datastore: state and events.</p>
<p><em>State</em>, in the form of the Active Contract Set by the function
<tt class="docutils literal">active(name)</tt>, uses the latest offset only, using the following rules:</p>
<pre class="code none literal-block">
creation_offset &lt;= latest_offset; AND
no archive_offset &lt;= latest_offset
</pre>
<p><em>Events</em> (create, exercise, archive) make use of the oldest and
latest range offset:</p>
<pre class="code none literal-block">
event_offset &lt;= latest_offset; AND
event_offset &gt;= oldest_offset
</pre>
</div>
<div class="section" id="write-pipeline">
<h3>Write pipeline</h3>
<p>Typically, you don't need to be concerned with how the
write pipeline is implemented. The above Read API takes
the write pipeline implementation into consideration.
The above Read API is the recommended way to query the
datastore. The following information is provided for completeness.</p>
<p>A Daml transaction is a collection of events that take effect on the
ledger atomically. However, for performance
reasons, these transactions are written to the datastore <em>in parallel</em>.
Although the datastore is written to in a purely append-only fashion,
it is not guaranteed that these transactions are visible to
readers in order. The offset-based model makes the database's isolation
level irrelevant, so the loosest model (<tt class="docutils literal">read uncommitted</tt>) is not
harmful.</p>
<p>When querying the datastore, first consider the type of
read consistency required. If there is no need for consistency (for example,
reading a historical contract regardless of lifetime), you can query payload
tables directly without any consideration of offset.
Another example is a liveness metric query that calculates the
number of transactions in the datastore over the past minute.
This could be valid without considering the
parallel-writing method.</p>
<p>When consistency is required, the reader must be aware of the offset
for reading. This ensures the reader doesn't also read
further offsets that are present when their precedent events are not yet
stored in the database.</p>
<p>To achieve the level of consistency that you require, including
read-consistency with other ledger data or commands you have executed,
consider providing a function that returns the latest
checkpoint offset:</p>
<pre class="code sql literal-block">
<span class="comment single">-- utility functions
</span><span class="keyword">create</span><span class="whitespace"> </span><span class="keyword">or</span><span class="whitespace"> </span><span class="keyword">replace</span><span class="whitespace"> </span><span class="keyword">function</span><span class="whitespace"> </span><span class="name">latest_checkpoint</span><span class="punctuation">()</span><span class="whitespace">
</span><span class="keyword">returns</span><span class="whitespace"> </span><span class="keyword">table</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="literal string symbol">&quot;offset&quot;</span><span class="whitespace"> </span><span class="name">_transactions</span><span class="punctuation">.</span><span class="literal string symbol">&quot;offset&quot;</span><span class="operator">%</span><span class="keyword">type</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">ix</span><span class="whitespace"> </span><span class="name">_transactions</span><span class="punctuation">.</span><span class="name">ix</span><span class="operator">%</span><span class="keyword">type</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="error">$$</span><span class="whitespace">
  </span><span class="keyword">select</span><span class="whitespace"> </span><span class="keyword">max</span><span class="punctuation">(</span><span class="name">groups</span><span class="punctuation">.</span><span class="literal string symbol">&quot;offset&quot;</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="literal string symbol">&quot;offset&quot;</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="keyword">max</span><span class="punctuation">(</span><span class="name">groups</span><span class="punctuation">.</span><span class="literal string symbol">&quot;ix&quot;</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="name">ix</span><span class="whitespace">
  </span><span class="keyword">from</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="name">ix</span><span class="whitespace"> </span><span class="operator">-</span><span class="whitespace"> </span><span class="name">ROW_NUMBER</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="name">OVER</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword">ORDER</span><span class="whitespace"> </span><span class="keyword">BY</span><span class="whitespace"> </span><span class="name">ix</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="name">delta</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace"> </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">_transactions</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="name">groups</span><span class="whitespace">
  </span><span class="keyword">group</span><span class="whitespace"> </span><span class="keyword">by</span><span class="whitespace"> </span><span class="name">groups</span><span class="punctuation">.</span><span class="name">delta</span><span class="whitespace">
  </span><span class="keyword">order</span><span class="whitespace"> </span><span class="keyword">by</span><span class="whitespace"> </span><span class="name">groups</span><span class="punctuation">.</span><span class="name">delta</span><span class="whitespace">
  </span><span class="keyword">limit</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">;</span><span class="whitespace">

</span><span class="error">$$</span><span class="whitespace"> </span><span class="keyword">language</span><span class="whitespace"> </span><span class="keyword">sql</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="keyword">create</span><span class="whitespace"> </span><span class="keyword">or</span><span class="whitespace"> </span><span class="keyword">replace</span><span class="whitespace"> </span><span class="keyword">function</span><span class="whitespace"> </span><span class="name">first_checkpoint</span><span class="punctuation">()</span><span class="whitespace">
</span><span class="keyword">returns</span><span class="whitespace"> </span><span class="keyword">table</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="literal string symbol">&quot;offset&quot;</span><span class="whitespace"> </span><span class="name">_transactions</span><span class="punctuation">.</span><span class="literal string symbol">&quot;offset&quot;</span><span class="operator">%</span><span class="keyword">type</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">ix</span><span class="whitespace"> </span><span class="name">_transactions</span><span class="punctuation">.</span><span class="name">ix</span><span class="operator">%</span><span class="keyword">type</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="error">$$</span><span class="whitespace">
  </span><span class="keyword">select</span><span class="whitespace"> </span><span class="name">t</span><span class="punctuation">.</span><span class="literal string symbol">&quot;offset&quot;</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="literal string symbol">&quot;offset&quot;</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">t</span><span class="punctuation">.</span><span class="literal string symbol">&quot;ix&quot;</span><span class="whitespace"> </span><span class="keyword">as</span><span class="whitespace"> </span><span class="name">ix</span><span class="whitespace"> </span><span class="keyword">from</span><span class="whitespace"> </span><span class="name">_transactions</span><span class="whitespace"> </span><span class="name">t</span><span class="whitespace"> </span><span class="keyword">order</span><span class="whitespace"> </span><span class="keyword">by</span><span class="whitespace"> </span><span class="name">ix</span><span class="whitespace"> </span><span class="keyword">limit</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">;</span>
</pre>
<p>Note that the <tt class="docutils literal">Archive</tt> table represents all <tt class="docutils literal">Archive</tt> choices in the given
namespace, such as <tt class="docutils literal">User.Archive</tt> and <tt class="docutils literal">Alias.Archive</tt> in the <tt class="docutils literal">User</tt> namespace.</p>
</div>
</div>
<div class="section" id="json-format">
<h2>JSON format</h2>
<p>PQS stores create and exercise arguments using a <a class="reference external" href="https://docs.daml.com/json-api/lf-value-specification.html#daml-lf-json-encoding">Daml-LF JSON-based encoding</a> of Daml-LF values. An overview of the encoding is provided below. For more details, refer to <a class="reference external" href="https://docs.daml.com/json-api/lf-value-specification.html#daml-lf-json-encoding">the Daml-LF page</a>.</p>
<p id="pqs-json-encoding">Values on the ledger can be primitive types, user-defined records, or variants. An extracted contract is represented in the database as a record of its create argument. The fields of that record are primitive types, other records, or variants. A contract can be a recursive structure of arbitrary depth.</p>
<p>These types are translated to <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/index.html">JSON types</a> as follows:</p>
<div class="section" id="primitive-types">
<h3>Primitive types</h3>
<ul class="simple">
<li><tt class="docutils literal">ContractID</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/string.html">string</a>.</li>
<li><tt class="docutils literal">Int64</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/string.html">string</a>.</li>
<li><tt class="docutils literal">Decimal</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/string.html">string</a>.</li>
<li><tt class="docutils literal">List</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/array.html">array</a>.</li>
<li><tt class="docutils literal">Text</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/string.html">string</a>.</li>
<li><tt class="docutils literal">Date</tt>: days since the Unix epoch, represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/numeric.html#integer">integer</a>.</li>
<li><tt class="docutils literal">Time</tt>: microseconds since the UNIX epoch, represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/numeric.html#number">number</a>.</li>
<li><tt class="docutils literal">Bool</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/boolean.html">boolean</a>.</li>
<li><tt class="docutils literal">Party</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/string.html">string</a>.</li>
<li><tt class="docutils literal">Unit</tt> and <tt class="docutils literal">Empty</tt>: Represented as empty records.</li>
<li><tt class="docutils literal">Optional</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/object.html">object</a>. It is a variant with two possible constructors: <tt class="docutils literal">None</tt> and <tt class="docutils literal">Some</tt>.</li>
</ul>
</div>
<div class="section" id="user-defined-types">
<h3>User-defined types</h3>
<ul class="simple">
<li><tt class="docutils literal">Record</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/object.html">object</a>, where each create parameter's name is a key, and the parameter's value is the JSON-encoded value.</li>
<li><tt class="docutils literal">Variant</tt>: represented as <a class="reference external" href="https://json-schema.org/understanding-json-schema/reference/object.html">object</a>, using the <tt class="docutils literal">{constructor: body}</tt> format, such as <tt class="docutils literal">{&quot;Left&quot;: true}</tt>.</li>
</ul>
</div>
</div>
<div class="section" id="display-of-metadata-inferred-database-schema">
<h2>Display of metadata-inferred database schema</h2>
<p>PQS analyzes package metadata as part of its operation and displays the required schema as shown in the following example:</p>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>./scribe.jar<span class="whitespace"> </span>datastore<span class="whitespace"> </span>postgres-document<span class="whitespace"> </span>schema<span class="whitespace"> </span>show<span class="whitespace">
</span><span class="operator">[</span>...<span class="operator">]</span><span class="whitespace">
</span>/**********************************************************<span class="whitespace">
</span>*<span class="whitespace"> </span>generated<span class="whitespace"> </span>by<span class="whitespace"> </span>scribe,<span class="whitespace"> </span>version:<span class="whitespace"> </span>v0.0.1-main+2151-7961ecb<span class="whitespace"> </span>*<span class="whitespace">
</span>**********************************************************/<span class="whitespace">
</span>--<span class="whitespace"> </span>tables<span class="whitespace">
</span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span>_transactions<span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
</span><span class="literal string double">&quot;offset&quot;</span><span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
</span>ix<span class="whitespace"> </span>bigint<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
</span>transaction_id<span class="whitespace"> </span>text,<span class="whitespace">
</span>effective_at<span class="whitespace"> </span>timestamp<span class="whitespace"> </span>with<span class="whitespace"> </span><span class="name builtin">time</span><span class="whitespace"> </span>zone,<span class="whitespace">
</span>workflow_id<span class="whitespace"> </span>text<span class="whitespace">
</span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="operator">[</span>...<span class="operator">]</span>
</pre>
<p><em>or</em> it applies the schema on the fly idempotently (default).</p>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>./scribe.jar<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>ledger<span class="whitespace"> </span>postgres-document<span class="whitespace"> </span>--pipeline-party<span class="operator">=</span>Alice<span class="whitespace">
</span><span class="literal number">18</span>:27:26.799<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-64<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.appversion.package:11<span class="whitespace"> </span>scribe,<span class="whitespace"> </span>version:<span class="whitespace"> </span>v0.0.1-main+2151-7961ecb<span class="whitespace">
</span><span class="literal number">18</span>:27:27.159<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-68<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.configuration.package:40<span class="whitespace"> </span>Applied<span class="whitespace"> </span>configuration:<span class="whitespace">
</span>pipeline<span class="whitespace"> </span><span class="operator">{</span><span class="whitespace">
</span><span class="name variable">datasource</span><span class="operator">=</span>TransactionStream<span class="whitespace">
</span><span class="operator">[</span>...<span class="operator">]</span><span class="whitespace">
</span><span class="literal number">18</span>:27:28.714<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-67<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.postgres.document.DocumentPostgres.Service:36<span class="whitespace"> </span>Applying<span class="whitespace"> </span>schema<span class="whitespace">
</span><span class="literal number">18</span>:27:28.805<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-67<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.postgres.document.DocumentPostgres.Service:39<span class="whitespace"> </span>Schema<span class="whitespace"> </span>applied<span class="whitespace">
</span><span class="literal number">18</span>:27:28.863<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-0<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.pipeline.pipeline.Impl:29<span class="whitespace"> </span>Starting<span class="whitespace"> </span>pipeline<span class="whitespace"> </span>on<span class="whitespace"> </span>behalf<span class="whitespace"> </span>of<span class="whitespace">
</span><span class="literal string single">'party-e303d252-1e35-46cb-b4e6-06538271d927::1220883670ff44119c947deeabb2e07827adff83bed3e1a897f53f73b0f61d509952'</span><span class="whitespace">
</span><span class="literal number">18</span>:27:29.043<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-0<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.pipeline.pipeline.Impl:57<span class="whitespace"> </span>Last<span class="whitespace"> </span>checkpoint<span class="whitespace"> </span>is<span class="whitespace"> </span>absent.<span class="whitespace">
</span>Seeding<span class="whitespace"> </span>from<span class="whitespace"> </span>ACS<span class="whitespace"> </span>before<span class="whitespace"> </span>processing<span class="whitespace"> </span>transactions<span class="whitespace"> </span>with<span class="whitespace"> </span>starting<span class="whitespace"> </span>offset<span class="whitespace"> </span><span class="literal string single">'000000000000000008'</span><span class="whitespace">
</span><span class="literal number">18</span>:27:29.063<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-938<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.zio.daml.Ledger.Impl:191<span class="whitespace"> </span>Contract<span class="whitespace"> </span>filter<span class="whitespace"> </span>inclusive<span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">2</span><span class="whitespace"> </span>templates<span class="whitespace">
</span>and<span class="whitespace"> </span><span class="literal number">0</span><span class="whitespace"> </span>interfaces<span class="whitespace">
</span><span class="literal number">18</span>:27:29.120<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-0<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.pipeline.pipeline.Impl:74<span class="whitespace"> </span>Continuing<span class="whitespace"> </span>from<span class="whitespace"> </span>offset<span class="whitespace"> </span><span class="literal string single">'GENESIS'</span><span class="whitespace"> </span>and<span class="whitespace">
</span>index<span class="whitespace"> </span><span class="literal string single">'0'</span><span class="whitespace"> </span><span class="keyword">until</span><span class="whitespace"> </span>offset<span class="whitespace"> </span><span class="literal string single">'INFINITY'</span><span class="whitespace">
</span><span class="literal number">18</span>:27:29.159<span class="whitespace"> </span>I<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-967<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.zio.daml.Ledger.Impl:191<span class="whitespace"> </span>Contract<span class="whitespace"> </span>filter<span class="whitespace"> </span>inclusive<span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">2</span><span class="whitespace"> </span>templates<span class="whitespace">
</span>and<span class="whitespace"> </span><span class="literal number">0</span><span class="whitespace"> </span>interfaces<span class="whitespace">
</span><span class="operator">[</span>...<span class="operator">]</span>
</pre>
</div>
<div class="section" id="pqs-database-schema">
<h2>PQS database schema</h2>
<p>The following schema is representative for the exported ledger data. It is subject to change since it is hidden behind the table functions.</p>
<pre class="code bash literal-block">
/**********************************************************<span class="whitespace">
 </span>*<span class="whitespace"> </span>generated<span class="whitespace"> </span>by<span class="whitespace"> </span>scribe,<span class="whitespace"> </span>version:<span class="whitespace"> </span>v0.0.1-main+2151-7961ecb<span class="whitespace"> </span>*<span class="whitespace">
 </span>**********************************************************/<span class="whitespace">
 </span>--<span class="whitespace"> </span>tables<span class="whitespace">
 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span>_transactions<span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span><span class="literal string double">&quot;offset&quot;</span><span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>ix<span class="whitespace"> </span>bigint<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>transaction_id<span class="whitespace"> </span>text,<span class="whitespace">
   </span>effective_at<span class="whitespace"> </span>timestamp<span class="whitespace"> </span>with<span class="whitespace"> </span><span class="name builtin">time</span><span class="whitespace"> </span>zone,<span class="whitespace">
   </span>workflow_id<span class="whitespace"> </span>text<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span>_exercises<span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>choice<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>contract_id<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span><span class="literal string double">&quot;offset&quot;</span><span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_transactions<span class="whitespace"> </span><span class="operator">(</span><span class="literal string double">&quot;offset&quot;</span><span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade<span class="whitespace"> </span>on<span class="whitespace"> </span>update<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>consuming<span class="whitespace"> </span>bool,<span class="whitespace">
   </span>witnesses<span class="whitespace"> </span>text<span class="operator">[]</span>,<span class="whitespace">
   </span>parent<span class="whitespace"> </span>text<span class="whitespace"> </span>references<span class="whitespace"> </span>_exercises<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span>_creates<span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>contract_id<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span><span class="literal string double">&quot;offset&quot;</span><span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_transactions<span class="whitespace"> </span><span class="operator">(</span><span class="literal string double">&quot;offset&quot;</span><span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade<span class="whitespace"> </span>on<span class="whitespace"> </span>update<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>witnesses<span class="whitespace"> </span>text<span class="operator">[]</span>,<span class="whitespace">
   </span>parent<span class="whitespace"> </span>text<span class="whitespace"> </span>references<span class="whitespace"> </span>_exercises<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span>_archives<span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>contract_id<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span><span class="literal string double">&quot;offset&quot;</span><span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_transactions<span class="whitespace"> </span><span class="operator">(</span><span class="literal string double">&quot;offset&quot;</span><span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade<span class="whitespace"> </span>on<span class="whitespace"> </span>update<span class="whitespace"> </span>cascade<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span>_mappings<span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>daml_fqn<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>pg_identifier<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>unique<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>--<span class="whitespace"> </span>PAYLOAD<span class="whitespace"> </span>TABLES<span class="whitespace">
 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span><span class="literal string double">&quot;Alias.39p75i&quot;</span><span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_creates<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>identifier<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>contract_key<span class="whitespace"> </span>jsonb,<span class="whitespace">
   </span>payload<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span><span class="literal string double">&quot;User.11jk59n1&quot;</span><span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_creates<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>identifier<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>contract_key<span class="whitespace"> </span>jsonb,<span class="whitespace">
   </span>payload<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span><span class="literal string double">&quot;Archive.2gpwea&quot;</span><span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_exercises<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>ondelete<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>identifier<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>argument<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>result<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span><span class="literal string double">&quot;Alias_Change.11wa21n1&quot;</span><span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_exercises<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>identifier<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>argument<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>result<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span><span class="whitespace">

 </span>create<span class="whitespace"> </span>table<span class="whitespace"> </span><span class="keyword">if</span><span class="whitespace"> </span>not<span class="whitespace"> </span>exists<span class="whitespace"> </span><span class="literal string double">&quot;User_Follow.11q646ez&quot;</span><span class="whitespace"> </span><span class="operator">(</span><span class="whitespace">
   </span>event_id<span class="whitespace"> </span>text<span class="whitespace"> </span>primary<span class="whitespace"> </span>key<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace"> </span>references<span class="whitespace"> </span>_exercises<span class="whitespace"> </span><span class="operator">(</span>event_id<span class="operator">)</span><span class="whitespace"> </span>on<span class="whitespace"> </span>delete<span class="whitespace"> </span>cascade,<span class="whitespace">
   </span>identifier<span class="whitespace"> </span>text<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>argument<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null,<span class="whitespace">
   </span>result<span class="whitespace"> </span>jsonb<span class="whitespace"> </span>not<span class="whitespace"> </span>null<span class="whitespace">
 </span><span class="operator">)</span><span class="punctuation">;</span>
</pre>
<p>Note that the Archive table represents all Archive choices in the given namespace, such as <tt class="docutils literal">User.Archive</tt> and <tt class="docutils literal">Alias.Archive</tt> in the User namespace.</p>
</div>
</div>
<div class="section" id="operate-pqs">
<h1>Operate PQS</h1>
<p>This section discusses common tasks when operating a PQS.</p>
<div class="section" id="check-health">
<h2>Check Health</h2>
<p>The health of the Scribe component that feeds data to the Postgres database can be monitored using the health check
endpoint <tt class="docutils literal">/livez</tt>. The health check endpoint is available at the <tt class="docutils literal"><span class="pre">--health-port</span></tt> specified when launching Scribe:</p>
<blockquote>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--health-port <var>int</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>HTTP port to use to expose application health info (default: 8080)</td></tr>
</tbody>
</table>
</blockquote>
<pre class="code bash literal-block">
$<span class="whitespace"> </span>curl<span class="whitespace"> </span>http://&lt;host&gt;:&lt;health-port&gt;/livez<span class="whitespace">
</span><span class="operator">{</span><span class="literal string double">&quot;status&quot;</span>:<span class="literal string double">&quot;ok&quot;</span><span class="operator">}</span>
</pre>
</div>
<div class="section" id="purge-excessive-historical-ledger-data">
<h2>Purge excessive historical ledger data</h2>
<p>Pruning ledger data from the PQS database can reduce storage size and
improve query performance by removing old data. PQS
provides two approaches to prune ledger data: using the PQS CLI or
using the <tt class="docutils literal">prune_to_offset</tt> PostgreSQL function.</p>
<p><strong>WARNING:</strong> Calling either the <tt class="docutils literal">prune</tt> CLI command with
<tt class="docutils literal"><span class="pre">--prune-mode</span> Force</tt> or calling the PostgreSQL function
<tt class="docutils literal">prune_to_offset</tt> deletes data irrevocably.</p>
<p>Both pruning approaches (CLI and PostgreSQL function) share the same
behavior in terms of data deletion and changes.</p>
<p>Active contracts are preserved under a new offset, while all other
transaction-related data up to and including the target offset is
deleted.</p>
<p id="pqs-pruning-behavior">The target offset (the offset provided by <tt class="docutils literal"><span class="pre">--prune-target</span></tt> or as an
argument to <tt class="docutils literal">prune_to_offset</tt>) is the transaction with the highest
offset to be deleted by the pruning operation.</p>
<p>Note: If the provided offset (by <tt class="docutils literal"><span class="pre">--prune-target</span></tt> or as an
argument to <tt class="docutils literal">prune_to_offset</tt>) doesn't have a transaction record,
the effective target offset is the oldest transaction offset
that succeeds (is greater than) the provided offset.</p>
<p>When using either pruning method, the following data changes:</p>
<ul class="simple">
<li>The offset of active contracts moves to the oldest known
offset that succeeds the pruning target offset, which is the offset of
the oldest transaction that is unaffected by the pruning operation.</li>
</ul>
<p>The following data is deleted:</p>
<ul class="simple">
<li>Transactions with offsets up to and including the target offset.</li>
<li>Events, archived contracts, and exercise payloads associated with the
deleted transactions.</li>
</ul>
<p>The following data is unaffected:</p>
<ul class="simple">
<li>Transaction-related data (event, choices, or contracts) for a transaction with
an offset that is greater than the effective pruning target offset.</li>
</ul>
<p>Pruning is a destructive operation and cannot be undone. If necessary,
make sure to back up your data before performing any pruning operations.</p>
<p>There are some constraints when using either pruning method:</p>
<ul class="simple">
<li>The provided target offset must be within the bounds of the
contiguous history. If the target offset is outside the bounds, an
error is raised.</li>
<li>The pruning operation cannot coincide with the latest consistent
checkpoint of the contiguous history. If it does, an error is
raised.</li>
</ul>
<div class="section" id="prune-with-pqs-cli">
<h3>Prune with PQS CLI</h3>
<p>The PQS CLI provides a <tt class="docutils literal">prune</tt> command to prune the
ledger data up to a specified offset, timestamp, or duration.</p>
<p>For detailed information on all available options, please run
<tt class="docutils literal">./PQS.jar datastore <span class="pre">postgres-document</span> prune <span class="pre">--help-verbose</span></tt>.</p>
<p>To use the <tt class="docutils literal">prune</tt> command, provide a pruning target as an
argument. The pruning target can be an offset, a timestamp (ISO 8601),
or a duration (ISO 8601):</p>
<pre class="literal-block">
./PQS.jar datastore postgres-document prune --prune-target &lt;pruning_target&gt;
</pre>
<p>By default, the <tt class="docutils literal">prune</tt> command performs a dry run, which means it
will only display the effects of the pruning operation without actually
deleting any data. To execute the pruning operation, add the
<tt class="docutils literal"><span class="pre">--prune-mode</span> Force</tt> option:</p>
<pre class="literal-block">
./PQS.jar datastore postgres-document prune --prune-target &lt;pruning_target&gt; --prune-mode Force
</pre>
<p>Instead of providing an offset as the <tt class="docutils literal"><span class="pre">--prune-target</span></tt>, you can use a timestamp
or duration as the pruning cutoff. For example, the following command prunes
data older than 30 days (relative to now):</p>
<pre class="literal-block">
./PQS.jar datastore postgres-document prune --prune-target P30D
</pre>
<p>The following example prunes data up to a specific timestamp:</p>
<pre class="literal-block">
./PQS.jar datastore postgres-document prune --prune-target 2023-01-30T00:00:00.000Z
</pre>
</div>
<div class="section" id="prune-with-prune-to-offset">
<h3>Prune with <tt class="docutils literal">prune_to_offset</tt></h3>
<p>The <tt class="docutils literal">prune_to_offset</tt> PostgreSQL function
prunes ledger data up to a specified offset. It has the same
behavior as the <tt class="docutils literal">datastore <span class="pre">postgres-document</span> prune</tt> command, except it does not
offer dry runs.</p>
<p>To use <tt class="docutils literal">prune_to_offset</tt>, provide an offset as a text
argument:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace"> </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">prune_to_offset</span><span class="punctuation">(</span><span class="literal string single">'&lt;offset&gt;'</span><span class="punctuation">);</span>
</pre>
<p>This function deletes transactions and updates active contracts as
described <a class="reference external" href="#pqs-pruning-behavior">earlier in this section</a>.</p>
<p>To prune data up to a specific timestamp or interval, use <tt class="docutils literal">prune_to_offset</tt>
in combination with the <tt class="docutils literal">get_offset</tt> function. For example, the following
query prunes data older than 30 days:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace"> </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">prune_to_offset</span><span class="punctuation">(</span><span class="name">get_offset</span><span class="punctuation">(</span><span class="name builtin">interval</span><span class="whitespace"> </span><span class="literal string single">'30 days'</span><span class="punctuation">));</span>
</pre>
</div>
</div>
</div>
<div class="section" id="optimize-pqs">
<h1>Optimize PQS</h1>
<p>This section briefly discusses optimizing a database. The topic is broad, and there are many resources available. Refer to the <a class="reference external" href="https://www.postgresql.org/docs/">PostgreSQL documentation</a> for more information.</p>
<div class="section" id="indexing">
<h2>Indexing</h2>
<p>Indexes are an important tool to make queries with (JSON) expressions perform well. Here is one example of an index:</p>
<pre class="code sql literal-block">
<span class="keyword">CREATE</span><span class="whitespace"> </span><span class="keyword">INDEX</span><span class="whitespace"> </span><span class="name">issueDateIdx</span><span class="whitespace">
</span><span class="keyword">ON</span><span class="whitespace"> </span><span class="name">contract</span><span class="whitespace">
</span><span class="keyword">USING</span><span class="whitespace"> </span><span class="name">BTREE</span><span class="whitespace"> </span><span class="punctuation">((</span><span class="name">payload</span><span class="operator">-&gt;</span><span class="literal string single">'issuanceData'</span><span class="operator">-&gt;</span><span class="literal string single">'issueDate'</span><span class="operator">-&gt;&gt;</span><span class="literal string single">'Some'</span><span class="punctuation">));</span>
</pre>
<p>In this example, the index allows comparisons on the issue date. It has the additional advantage that the results of the JSON query <tt class="docutils literal"><span class="pre">payload-&gt;'issuanceData'-&gt;'issueDate'-&gt;&gt;'Some'</span></tt> are cached and do not have to be recomputed for every access.</p>
<p>PostgreSQL provides several index types, including B-tree, Hash, GiST, SP-GiST, GIN, and BRIN. Each index type uses a different algorithm that is best suited to different types of queries. The table below provides a basic explanation of where they can be used. For a more thorough understanding, consult the <a class="reference external" href="https://www.postgresql.org/docs/current/indexes.html">chapter on indexes</a> in the PostgreSQL manual.</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Index
Type</th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Hash</td>
<td>Compact. Useful only for filters that use =.</td>
</tr>
<tr><td>B-tree</td>
<td>Can be used in filters that use &lt;, &lt;=, =, &gt;=, &gt; as well
as postfix string comparisons (e.g. LIKE 'foo%').
B-trees can also speed up ORDER BY clauses and can be
used to retrieve subexpressions values from the index
rather than evaluating the subexpressions (i.e. when
used in a SELECT clause).</td>
</tr>
<tr><td>GIN</td>
<td>Useful for subset operators.</td>
</tr>
<tr><td>GiST,
SP-GiST</td>
<td>See manual.</td>
</tr>
<tr><td>BRIN</td>
<td>Efficient for tables where rows are already physically
sorted for a particular column.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="pagination">
<h2>Pagination</h2>
<p>Pagination refers to splitting up large result sets into pages of up to <tt class="docutils literal">n</tt> results. It can allow user navigation such as moving to the next page to display, going to the end of the result set, or jumping around in the middle. It can be a very effective user experience when there is a large ordered data set. The following pagination use cases are important:</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="25%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Pagination
Use Case</th>
<th class="head">&nbsp;</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Random access</td>
<td>Accessing
arbitrary pages</td>
<td><ul class="first last simple">
<li><dl class="first docutils">
<dt>Client side binary search</dt>
<dd>of results.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A user opens random pages</dt>
<dd>in a search result.</dd>
</dl>
</li>
</ul>
</td>
</tr>
<tr><td>Iteration or
enumeration</td>
<td>Accessing page
1, then page 2,
...</td>
<td><ul class="first last simple">
<li><dl class="first docutils">
<dt>Programmatic processing of</dt>
<dd>all results in batches.</dd>
</dl>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>For efficient pagination iteration, you need a column to sort on. The requirements are:</p>
<ol class="arabic simple">
<li>It should be acceptable to the user to sort results on this column.</li>
<li>You need a (unique) B-tree index on this column.</li>
<li>The column must have unique values.</li>
</ol>
<p>You can then perform queries like this:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace">
</span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">the_table</span><span class="whitespace">
</span><span class="keyword">WHERE</span><span class="whitespace"> </span><span class="name">the_sort_col</span><span class="whitespace"> </span><span class="operator">&gt;</span><span class="whitespace"> </span><span class="operator">???</span><span class="whitespace">
</span><span class="keyword">ORDER</span><span class="whitespace"> </span><span class="keyword">BY</span><span class="whitespace"> </span><span class="name">the_sort_col</span><span class="whitespace">
</span><span class="keyword">LIMIT</span><span class="whitespace"> </span><span class="literal number integer">100</span><span class="punctuation">;</span>
</pre>
<p>The <tt class="docutils literal"><span class="pre">???</span></tt> value represents the last (largest) value for <tt class="docutils literal">the_sort_col</tt> that was previously returned. To fetch results for the very first page, omit the <tt class="docutils literal">WHERE</tt> clause.</p>
<p>Here is an example of random access to display page 10 of the search results:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace">
</span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">the_table</span><span class="whitespace">
</span><span class="keyword">ORDER</span><span class="whitespace"> </span><span class="keyword">BY</span><span class="whitespace"> </span><span class="name">the_sort_col</span><span class="whitespace">
</span><span class="keyword">LIMIT</span><span class="whitespace"> </span><span class="literal number integer">100</span><span class="whitespace">
</span><span class="keyword">OFFSET</span><span class="whitespace"> </span><span class="literal number integer">1000</span><span class="punctuation">;</span>
</pre>
<p>This only makes sense if there is a B-tree index on <tt class="docutils literal">the_sort_col</tt>.</p>
<p>You should assume that a large <tt class="docutils literal">OFFSET</tt> is slow. See the chapter on <a class="reference external" href="https://www.postgresql.org/docs/current/queries-limit.html">LIMIT and OFFSET</a> in the PostgreSQL manual.</p>
</div>
<div class="section" id="psql-tips">
<h2>psql tips</h2>
<p>Type <tt class="docutils literal">psql &lt;dbname&gt;</tt> on the command line to enter the PostgreSQL <tt class="docutils literal">`REPL`</tt> (if in doubt, use postgres as the database name). Some useful commands are shown in the following table.</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Command</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>\l</td>
<td>List all databases.</td>
</tr>
<tr><td>\c db</td>
<td>Switch to a different database.</td>
</tr>
<tr><td>\d</td>
<td>List all tables in the current database.</td>
</tr>
<tr><td>\d
table</td>
<td>Show a table, including column types and indexes.</td>
</tr>
</tbody>
</table>
<p>To create databases and users, try this:</p>
<pre class="code sql literal-block">
<span class="keyword">CREATE</span><span class="whitespace"> </span><span class="keyword">DATABASE</span><span class="whitespace"> </span><span class="name">the_db</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="keyword">CREATE</span><span class="whitespace"> </span><span class="keyword">USER</span><span class="whitespace"> </span><span class="name">the_user</span><span class="whitespace"> </span><span class="keyword">WITH</span><span class="whitespace"> </span><span class="name">PASSWORD</span><span class="whitespace"> </span><span class="literal string single">'abc123'</span><span class="punctuation">;</span>
</pre>
<p>To later remove them, try this:</p>
<pre class="code sql literal-block">
<span class="keyword">DROP</span><span class="whitespace"> </span><span class="keyword">DATABASE</span><span class="whitespace"> </span><span class="name">the_db</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="keyword">DROP</span><span class="whitespace"> </span><span class="keyword">USER</span><span class="whitespace"> </span><span class="name">the_user</span><span class="punctuation">;</span>
</pre>
<p>psql can also be used for scripting:</p>
<pre class="code bash literal-block">
psql<span class="whitespace"> </span>postgres<span class="whitespace"> </span><span class="literal string">&lt;&lt;END
...
CREATE DATABASE the_db;
...
END</span>
</pre>
<p>The script continues to execute if a command fails.</p>
</div>
<div class="section" id="explain-analyze">
<h2>EXPLAIN ANALYZE</h2>
<p>Type <tt class="docutils literal">EXPLAIN ANALYZE</tt> followed by a query in <tt class="docutils literal">psql</tt> or similar tools to get an explanation of how the query would be executed. This is an invaluable tool to verify that a query you might want to run uses the indexes that you think it does.</p>
<pre class="code sql literal-block">
<span class="keyword">EXPLAIN</span><span class="whitespace"> </span><span class="keyword">ANALYZE</span><span class="whitespace">
</span><span class="keyword">SELECT</span><span class="whitespace"> </span><span class="keyword">COUNT</span><span class="punctuation">(</span><span class="operator">*</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">FROM</span><span class="whitespace"> </span><span class="name">the_table</span><span class="punctuation">;</span>
</pre>
</div>
</div>
<div class="section" id="troubleshoot">
<h1>Troubleshoot</h1>
<p>Some of the most common troubleshooting options are discussed below.</p>
<div class="section" id="cannot-connect-to-the-ledger-node">
<h2>Cannot connect to the ledger node</h2>
<p>If the PQS cannot connect to the ledger node on startup, you see a message in the logs like the following example and the PQS terminates.</p>
<pre class="code bash literal-block">
<span class="literal number">21</span>:15:02.084<span class="whitespace"> </span>E<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-0<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.app.ComposableApp:34<span class="whitespace"> </span>Exception<span class="whitespace"> </span><span class="keyword">in</span><span class="whitespace"> </span>thread<span class="whitespace">
</span><span class="literal string double">&quot;zio-fiber-&quot;</span><span class="whitespace"> </span>io.grpc.StatusException:<span class="whitespace"> </span>UNAVAILABLE:<span class="whitespace"> </span>io<span class="whitespace"> </span>exception<span class="whitespace">
  </span>at<span class="whitespace">
</span>scalapb.zio_grpc.client.UnaryClientCallListener.onClose<span class="name variable">$$</span>anonfun<span class="name variable">$1$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>UnaryClientCallListener.scala:61<span class="operator">)</span><span class="whitespace">
  </span>Suppressed:<span class="whitespace">
</span>io.netty.channel.AbstractChannel<span class="name variable">$AnnotatedConnectException</span>:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>refused:<span class="whitespace">
</span>localhost/<span class="operator">[</span><span class="literal number">0</span>:0:0:0:0:0:0:1<span class="operator">]</span>:6865<span class="whitespace">
    </span>Suppressed:<span class="whitespace"> </span>java.net.ConnectException:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>refused<span class="whitespace">
      </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.Net.pollConnect<span class="operator">(</span>Native<span class="whitespace"> </span>Method<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.Net.pollConnectNow<span class="operator">(</span>Net.java:672<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.SocketChannelImpl.finishConnect<span class="operator">(</span>SocketChannelImpl.java:946<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect<span class="operator">(</span>NioSocketChannel.java:337<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.channel.nio.AbstractNioChannel<span class="name variable">$AbstractNioUnsafe</span>.finishConnect<span class="operator">(</span>AbstractNioChannel.java:334<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.channel.nio.NioEventLoop.processSelectedKey<span class="operator">(</span>NioEventLoop.java:776<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized<span class="operator">(</span>NioEventLoop.java:724<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.channel.nio.NioEventLoop.processSelectedKeys<span class="operator">(</span>NioEventLoop.java:650<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.channel.nio.NioEventLoop.run<span class="operator">(</span>NioEventLoop.java:562<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.util.concurrent.SingleThreadEventExecutor<span class="name variable">$4</span>.run<span class="operator">(</span>SingleThreadEventExecutor.java:997<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.util.internal.ThreadExecutorMap<span class="name variable">$2</span>.run<span class="operator">(</span>ThreadExecutorMap.java:74<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>io.netty.util.concurrent.FastThreadLocalRunnable.run<span class="operator">(</span>FastThreadLocalRunnable.java:30<span class="operator">)</span><span class="whitespace">
      </span>at<span class="whitespace"> </span>java.base/java.lang.Thread.run<span class="operator">(</span>Thread.java:833<span class="operator">)</span><span class="whitespace">
</span>io.grpc.StatusException:<span class="whitespace"> </span>UNAVAILABLE:<span class="whitespace"> </span>io<span class="whitespace"> </span>exception<span class="whitespace">
</span>io.netty.channel.AbstractChannel.AnnotatedConnectException:<span class="whitespace"> </span>Connection<span class="whitespace">
</span>refused:<span class="whitespace"> </span>localhost/<span class="operator">[</span><span class="literal number">0</span>:0:0:0:0:0:0:1<span class="operator">]</span>:6865<span class="whitespace">
</span>java.net.ConnectException:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>refused
</pre>
<p>To fix this, make sure that the participant node's ledger API is accessible from where you are running the PQS.</p>
</div>
<div class="section" id="cannot-connect-to-the-pqs-database">
<h2>Cannot connect to the PQS database</h2>
<p>If the database is not available before the transaction stream is started, the PQS terminates and you see an error from the JDBC driver in the logs similar to the following example.</p>
<pre class="code bash literal-block">
<span class="literal number">21</span>:16:32.116<span class="whitespace"> </span>E<span class="whitespace"> </span><span class="operator">[</span>zio-fiber-0<span class="operator">]</span><span class="whitespace"> </span>com.digitalasset.scribe.app.ComposableApp:34<span class="whitespace"> </span>Exception<span class="whitespace"> </span><span class="keyword">in</span><span class="whitespace"> </span>thread<span class="whitespace">
</span><span class="literal string double">&quot;zio-fiber-&quot;</span><span class="whitespace"> </span>org.postgresql.util.PSQLException:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>to<span class="whitespace"> </span>localhost:5432<span class="whitespace"> </span>refused.<span class="whitespace"> </span>Check<span class="whitespace">
</span>that<span class="whitespace"> </span>the<span class="whitespace"> </span>hostname<span class="whitespace"> </span>and<span class="whitespace"> </span>port<span class="whitespace"> </span>are<span class="whitespace"> </span>correct<span class="whitespace"> </span>and<span class="whitespace"> </span>that<span class="whitespace"> </span>the<span class="whitespace"> </span>postmaster<span class="whitespace"> </span>is<span class="whitespace"> </span>accepting<span class="whitespace"> </span>TCP/IP<span class="whitespace"> </span>connections.<span class="whitespace">
  </span>at<span class="whitespace">
    </span>org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl<span class="operator">(</span>ConnectionFactoryImpl.java:342<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>org.postgresql.core.ConnectionFactory.openConnection<span class="operator">(</span>ConnectionFactory.java:54<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>org.postgresql.jdbc.PgConnection.&lt;init&gt;<span class="operator">(</span>PgConnection.java:263<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>org.postgresql.Driver.makeConnection<span class="operator">(</span>Driver.java:443<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>org.postgresql.Driver.connect<span class="operator">(</span>Driver.java:297<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>java.sql/java.sql.DriverManager.getConnection<span class="operator">(</span>DriverManager.java:681<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>java.sql/java.sql.DriverManager.getConnection<span class="operator">(</span>DriverManager.java:190<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>zio.jdbc.shims.postgres$.<span class="name variable">$anonfun$1</span><span class="operator">(</span>postgres.scala:21<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace">
    </span>zio.ZIOCompanionVersionSpecific.attempt<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>ZIOCompanionVersionSpecific.scala:103<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>zio.ZIO$.suspendSucceed<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>ZIO.scala:4589<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace">
    </span>zio.UnsafeVersionSpecific.implicitFunctionIsFunction<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>UnsafeVersionSpecific.scala:27<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>zio.Unsafe$.unsafe<span class="operator">(</span>Unsafe.scala:37<span class="operator">)</span><span class="whitespace">
  </span>at<span class="whitespace"> </span>zio.ZIOCompanionVersionSpecific.succeed<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>ZIOCompanionVersionSpecific.scala:185<span class="operator">)</span><span class="whitespace">
  </span>Suppressed:<span class="whitespace"> </span>java.net.ConnectException:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>refused<span class="whitespace">
    </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.Net.pollConnect<span class="operator">(</span>Native<span class="whitespace"> </span>Method<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.Net.pollConnectNow<span class="operator">(</span>Net.java:672<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect<span class="operator">(</span>NioSocketImpl.java:547<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.base/sun.nio.ch.NioSocketImpl.connect<span class="operator">(</span>NioSocketImpl.java:602<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.base/java.net.SocksSocketImpl.connect<span class="operator">(</span>SocksSocketImpl.java:327<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.base/java.net.Socket.connect<span class="operator">(</span>Socket.java:633<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.core.PGStream.createSocket<span class="operator">(</span>PGStream.java:243<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.core.PGStream.&lt;init&gt;<span class="operator">(</span>PGStream.java:98<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.core.v3.ConnectionFactoryImpl.tryConnect<span class="operator">(</span>ConnectionFactoryImpl.java:132<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace">
      </span>org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl<span class="operator">(</span>ConnectionFactoryImpl.java:258<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.core.ConnectionFactory.openConnection<span class="operator">(</span>ConnectionFactory.java:54<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.jdbc.PgConnection.&lt;init&gt;<span class="operator">(</span>PgConnection.java:263<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.Driver.makeConnection<span class="operator">(</span>Driver.java:443<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>org.postgresql.Driver.connect<span class="operator">(</span>Driver.java:297<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.sql/java.sql.DriverManager.getConnection<span class="operator">(</span>DriverManager.java:681<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>java.sql/java.sql.DriverManager.getConnection<span class="operator">(</span>DriverManager.java:190<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>zio.jdbc.shims.postgres$.<span class="name variable">$anonfun$1</span><span class="operator">(</span>postgres.scala:21<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace">
      </span>zio.ZIOCompanionVersionSpecific.attempt<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>ZIOCompanionVersionSpecific.scala:103<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>zio.ZIO$.suspendSucceed<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>ZIO.scala:4589<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace">
      </span>zio.UnsafeVersionSpecific.implicitFunctionIsFunction<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>UnsafeVersionSpecific.scala:27<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace"> </span>zio.Unsafe$.unsafe<span class="operator">(</span>Unsafe.scala:37<span class="operator">)</span><span class="whitespace">
    </span>at<span class="whitespace">
      </span>zio.ZIOCompanionVersionSpecific.succeed<span class="name variable">$$</span>anonfun<span class="name variable">$1</span><span class="operator">(</span>ZIOCompanionVersionSpecific.scala:185<span class="operator">)</span><span class="whitespace">
</span>org.postgresql.util.PSQLException:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>to<span class="whitespace"> </span>localhost:5432<span class="whitespace"> </span>refused.<span class="whitespace"> </span>Check<span class="whitespace"> </span>that<span class="whitespace">
</span>the<span class="whitespace"> </span>hostname<span class="whitespace"> </span>and<span class="whitespace"> </span>port<span class="whitespace"> </span>are<span class="whitespace"> </span>correct<span class="whitespace"> </span>and<span class="whitespace"> </span>that<span class="whitespace"> </span>the<span class="whitespace"> </span>postmaster<span class="whitespace"> </span>is<span class="whitespace"> </span>accepting<span class="whitespace"> </span>TCP/IP<span class="whitespace"> </span>connections.<span class="whitespace">
</span>java.net.ConnectException:<span class="whitespace"> </span>Connection<span class="whitespace"> </span>refused
</pre>
<p>To fix this, make sure that the database exists and is accessible from where you are running the PQS. Also, ensure that the database username and password are correct and that the credentials to connect to the database from the network address are set properly.</p>
<p>If the database connection is broken while the transaction stream is already running, you will see a similar message in the logs, but it will be repeated. The transaction stream is restarted with an exponential backoff. This gives the database, network, or any other troubled resource time to get back into shape. Once everything is in order, the stream continues without any need for manual intervention.</p>
</div>
</div>
</div>
</body>
</html>
