.. Copyright (c) 2023 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
.. SPDX-License-Identifier: Apache-2.0

Install ``canton-domain`` Chart
###############################

Objectives
**********

* Customize Helm chart parameters
* Install Helm chart
* Verify the status of the deployment

Steps
*****

1. Inspect the Helm value files generated by Terraform
======================================================

.. note::
   The Terraform scripts were used to parameterize the Helm values. If standalone Helm deployment is done without Terraform the value file has to be customized manually (see example below).

.. tabs::
  .. tab:: Azure
    Example `domain.yaml <https://github.com/DACH-NY/daml-enterprise-deployment-blueprints/blob/main/azure/helm/values/domain.yaml>`_:

    .. code-block:: yaml

      ---
      image:
        registry: "<container_image_registry_hostname>"

      storage:
        host: "<postgresql_server_hostname>"

      bootstrap:
        enabled: true

      console:
        enabled: true

      certManager:
        issuerGroup: certmanager.step.sm
        issuerKind: StepClusterIssuer

      common:
        tls:
          public:
            enabled: true
            certManager:
              issuerName: canton-tls-issuer
          admin:
            enabled: true
            certManager:
              issuerName: canton-tls-issuer

      manager:
        storage:
          database: "mydomain"
          user: "mydomain"
          existingSecret:
            name: "mydomain-postgresql"
            key: "mydomain"

      mediator:
        storage:
          database: "mymediator"
          user: "mymediator"
          existingSecret:
            name: "mymediator-postgresql"
            key: "mymediator"

      sequencer:
        storage:
          database: "mysequencer"
          user: "mysequencer"
          existingSecret:
            name: "mysequencer-postgresql"
            key: "mysequencer"

      testing:
        bootstrap:
          remoteParticipants:
            - name: "participant1"
              host: "participant1-canton-participant.canton.svc.cluster.local"
              tls:
                admin:
                  enabled: true
                  certManager:
                    issuerName: canton-tls-issuer
                  ca: "/tls-participant1/ca.crt"

  .. tab:: AWS
    Example `domain.yaml <https://github.com/DACH-NY/daml-enterprise-deployment-blueprints/blob/main/aws/helm/values/domain.yaml>`_:

      .. code-block:: yaml

        ---
        image:
          registry: "<container_image_registry_hostname>"

        storage:
          host: "<postgresql_server_hostname>"

        bootstrap:
          enabled: true

        console:
          enabled: true

        common:
          domainName: "mydomain"
          mediatorName: "mymediator"
          sequencerName: "mysequencer"
          tls:
            public:
              enabled: true
              certManager:
                issuerName: "aws-privateca-issuer"
            admin:
              enabled: true
              certManager:
                issuerName: "aws-privateca-issuer"

        manager:
          storage:
            database: "mydomain"
            user: "mydomain"
            existingSecret:
              name: "mydomain-postgresql"
              key: "mydomain"

        mediator:
          storage:
            database: "mymediator"
            user: "mymediator"
            existingSecret:
              name: "mymediator-postgresql"
              key: "mymediator"

        sequencer:
          storage:
            database: "mysequencer"
            user: "mysequencer"
            existingSecret:
              name: "mysequencer-postgresql"
              key: "mysequencer"

        testing:
          bootstrap:
            remoteParticipants:
              - name: "participant1"
                host: "participant1-canton-participant.canton.svc.cluster.local"
                tls:
                  admin:
                    enabled: true
                    certManager:
                      issuerName: "aws-privateca-issuer"
                    ca: "/tls-participant1/ca.crt"

.. note::
   To learn about the supported attributes for canton-domain, check out the documentation `here <https://artifacthub.io/packages/helm/digital-asset/canton-domain#parameters>`_.

2. Install the chart
====================

.. note::
  Depending on your cloud provider of choice, make sure the current directory is the ``azure/terraform`` or ``aws/terraform`` folder of your clone of the `accompanying resources <https://github.com/DACH-NY/daml-enterprise-deployment-blueprints/>`_.

With the value files prepared we can install the Helm chart:

.. code-block:: bash

   helm -n canton install mydomain digital-asset/canton-domain -f helm/values/domain.yaml

After the other resources are deployed and ready, the bootstrap job will start, it takes a few minutes. Once this job is completed, the Helm chart deployment is considered successful.

Expected output:

.. code-block:: bash

   NAME: mydomain
   LAST DEPLOYED: Wed Aug 16 16:27:15 2023
   NAMESPACE: canton
   STATUS: deployed
   REVISION: 1
   TEST SUITE: None
   NOTES:
   *
     _____            _
    / ____|          | |
   | |     __ _ _ __ | |_ ___  _ __
   | |    / _` | '_ \| __/ _ \| '_ \
   | |___| (_| | | | | || (_) | | | |
    \_____\__,_|_| |_|\__\___/|_| |_|

   Domain 2.7.1 has been deployed successfully!

   More information on how to configure Canton can be found in our documentation:

   https://docs.daml.com/

3. Check deployment status
==========================

We can check the status of the deployment using the following command:

.. code-block:: bash

   kubectl -n canton get pods

Expected output:

.. code-block:: bash

   NAME                                                READY   STATUS      RESTARTS   AGE
   mydomain-canton-domain-bootstrap-dcbsr              0/1     Completed   0          15m
   mydomain-canton-domain-console-6b86bf5d4f-djfj8     1/1     Running     0          15m
   mydomain-canton-domain-manager-59f8b9688d-kdgbk     1/1     Running     0          15m
   mydomain-canton-domain-mediator-75f7665845-kxt49    1/1     Running     0          15m
   mydomain-canton-domain-sequencer-5768f45457-bl4pb   1/1     Running     0          15m
   mydomain-canton-domain-sequencer-5768f45457-zkxf9   1/1     Running     0          15m
   participant1-canton-participant-647b99cb8b-dbzrw    1/1     Running     0          15m
